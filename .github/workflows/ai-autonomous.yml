name: AI Autonomous Development

on:
  issues:
    types: [labeled]

jobs:
  ai-pair-development:
    if: contains(github.event.issue.labels.*.name, 'ai-auto')
    runs-on: ubuntu-latest
    
    permissions:
      issues: write
      pull-requests: write
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
      
      - name: Install Gemini CLI
        run: |
          npm install -g @google-ai/generativelanguage
          # Note: Gemini CLI installation may vary based on the official package
          echo "Gemini CLI setup completed"
      
      - name: Setup environment
        run: |
          # Create outputs directory
          mkdir -p outputs
          chmod +x scripts/*.sh
          echo "Environment setup completed"
      
      - name: AI Autonomous Flow
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "Starting AI autonomous development for Issue #$ISSUE_NUMBER"
          echo "Title: $ISSUE_TITLE"
          
          # Execute AI pair flow
          ./scripts/ai_pair_flow.sh "$ISSUE_TITLE: $ISSUE_BODY"
          
          # Display results
          echo "=== AI Development Results ==="
          echo "Implementation completed. Results:"
          ls -la outputs/
      
      - name: Create feature branch
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          git config --global user.name "AI Pair Programming Bot"
          git config --global user.email "ai-bot@battleofrunteq.dev"
          
          BRANCH_NAME="ai-auto-$ISSUE_NUMBER"
          git checkout -b $BRANCH_NAME
          echo "Created branch: $BRANCH_NAME"
      
      - name: Commit AI implementation
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Add all generated/modified files
          git add .
          
          # Create commit message with AI results
          COMMIT_MSG="ğŸ¤– AIè‡ªå¾‹å®Ÿè£…: $ISSUE_TITLE

          ã“ã®å®Ÿè£…ã¯Claude-Geminiè‡ªå¾‹é€£æºã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

          å®Ÿè£…å†…å®¹:
          - Issue #$ISSUE_NUMBER ã®è¦ä»¶ã«åŸºã¥ãè‡ªå‹•å®Ÿè£…
          - Claude Code: åˆ†æãƒ»è¨ˆç”»ç«‹æ¡ˆãƒ»å“è³ªæ¤œè¨¼
          - Gemini CLI: ã‚³ãƒ¼ãƒ‰å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆç”Ÿæˆ

          è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«:
          $(git diff --name-only HEAD^ HEAD 2>/dev/null || echo 'New implementation files')

          ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¨å¥¨äº‹é …:
          - å®Ÿè£…ãƒ­ã‚¸ãƒƒã‚¯ã®ç¢ºèª
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …ã®æ¤œè¨¼
          - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç¢ºèª

          Co-authored-by: Claude-Code <claude@anthropic.com>
          Co-authored-by: Gemini-CLI <gemini@google.com>"
          
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"
      
      - name: Push feature branch
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          BRANCH_NAME="ai-auto-$ISSUE_NUMBER"
          git push origin $BRANCH_NAME
      
      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Read AI implementation results for PR description
          IMPLEMENTATION_SUMMARY=""
          if [ -f outputs/gemini_implementation.txt ]; then
            IMPLEMENTATION_SUMMARY=$(head -20 outputs/gemini_implementation.txt)
          fi
          
          REVIEW_SUMMARY=""
          if [ -f outputs/claude_review_*.json ]; then
            REVIEW_FILE=$(ls outputs/claude_review_*.json | tail -1)
            REVIEW_SUMMARY=$(cat $REVIEW_FILE)
          fi
          
          # Create PR with detailed information
          gh pr create \
            --title "ğŸ¤– AIè‡ªå¾‹å®Ÿè£…: $ISSUE_TITLE" \
            --body "## ğŸ¯ å®Ÿè£…æ¦‚è¦
          ã“ã® Pull Request ã¯ Claude-Gemini è‡ªå¾‹é€£æºã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…ã§ã™ã€‚

          **å…ƒIssue**: #$ISSUE_NUMBER
          **å®Ÿè£…å†…å®¹**: $ISSUE_TITLE

          ## ğŸ”„ AIé€£æºãƒ•ãƒ­ãƒ¼
          1. **Claude Code** - è¦ä»¶åˆ†æãƒ»æŠ€è¡“è¨ˆç”»ç«‹æ¡ˆ
          2. **Gemini CLI** - å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆç”Ÿæˆ  
          3. **Claude Code** - å“è³ªæ¤œè¨¼ãƒ»çµ±åˆç¢ºèª

          ## ğŸ“ å®Ÿè£…è©³ç´°
          \`\`\`
          $IMPLEMENTATION_SUMMARY
          \`\`\`

          ## ğŸ“Š å“è³ªè©•ä¾¡
          \`\`\`json
          $REVIEW_SUMMARY
          \`\`\`

          ## âœ… å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
          - [x] Rails 8 MVC ãƒ‘ã‚¿ãƒ¼ãƒ³æº–æ‹ 
          - [x] Bootstrap 5.2 UI å®Ÿè£…
          - [x] RSpec ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
          - [x] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …
          - [x] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

          ## ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦è«‹
          - [ ] ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®å¦¥å½“æ€§ç¢ºèª
          - [ ] UI/UX ã®é©åˆ‡æ€§ç¢ºèª
          - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
          - [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å½±éŸ¿ç¢ºèª

          ## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å‰ç¢ºèªäº‹é …
          - [ ] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ: \`bundle exec rspec\`
          - [ ] Lint ãƒã‚§ãƒƒã‚¯: \`bundle exec rubocop\`
          - [ ] é–‹ç™ºç’°å¢ƒå‹•ä½œç¢ºèª: \`docker-compose up\`

          ---
          ğŸ¤– **è‡ªå‹•ç”Ÿæˆ**: Claude-Gemini è‡ªå¾‹é€£æºã‚·ã‚¹ãƒ†ãƒ  v1.0
          ğŸ“… **ç”Ÿæˆæ—¥æ™‚**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          " \
            --label "ai-auto,review-required" \
            --assignee "@me"
      
      - name: Update Issue with results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Get final score and status from review
          FINAL_SCORE="æœªè©•ä¾¡"
          FINAL_STATUS="å®Œäº†"
          
          if [ -f outputs/claude_review_*.json ]; then
            REVIEW_FILE=$(ls outputs/claude_review_*.json | tail -1)
            FINAL_SCORE=$(grep '"score"' $REVIEW_FILE | grep -o '[0-9]*' | head -1)
            FINAL_STATUS=$(grep '"status"' $REVIEW_FILE | cut -d'"' -f4)
          fi
          
          # Comment on the original issue
          gh issue comment $ISSUE_NUMBER --body "## ğŸ¤– AIè‡ªå¾‹å®Ÿè£…å®Œäº†

          **å®Ÿè£…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Œäº†
          **å“è³ªã‚¹ã‚³ã‚¢**: $FINAL_SCORE/100
          **è©•ä¾¡çµæœ**: $FINAL_STATUS

          ### ğŸ“‹ ç”Ÿæˆçµæœ
          - ğŸ”— **Pull Request**: è‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸ
          - ğŸ“ **å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: AIé€£æºã«ã‚ˆã‚Šç”Ÿæˆ
          - ğŸ§ª **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**: RSpec ãƒ†ã‚¹ãƒˆå®Ÿè£…æ¸ˆã¿
          - ğŸ“Š **å“è³ªæ¤œè¨¼**: Claude Code ã«ã‚ˆã‚‹æ¤œè¨¼å®Œäº†

          ### ğŸ” æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          1. Pull Request ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„
          2. å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•èª¿æ•´ã‚’å®Ÿæ–½
          3. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ãƒ‡ãƒ—ãƒ­ã‚¤

          è©³ç´°ã¯ä½œæˆã•ã‚ŒãŸ Pull Request ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"