name: Claude Code

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

jobs:
  claude-code:
    if: |
      github.event.label.name == 'claude-code' || 
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CLAUDE_APP_ID }}
          private-key: ${{ secrets.CLAUDE_APP_PRIVATE_KEY }}
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
      
      - name: Get issue details
        id: issue
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ github.event.inputs.issue_number }}"
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi
          
          ISSUE_DATA=$(gh api repos/${{ github.repository }}/issues/${ISSUE_NUMBER})
          ISSUE_TITLE=$(echo "$ISSUE_DATA" | jq -r '.title')
          ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body')
          
          echo "number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
          echo "title=${ISSUE_TITLE}" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "${ISSUE_BODY}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
      
      - name: Create feature branch
        run: |
          git config user.name "claude-code[bot]"
          git config user.email "claude-code[bot]@users.noreply.github.com"
          
          BRANCH_NAME="claude-code/issue-${{ steps.issue.outputs.number }}"
          git checkout -b $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV
      
      - name: Execute Claude Code
        run: |
          # ã“ã“ã«Claude Codeå®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
          # ä¾‹: claude-code --issue "${{ steps.issue.outputs.number }}" --implement
          echo "Claude Codeå®Ÿè¡Œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆä¸­..."
          echo "Issue #${{ steps.issue.outputs.number }}: ${{ steps.issue.outputs.title }}"

          # ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆissuesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«çµ±åˆï¼‰
          mkdir -p issues/claude-outputs
          echo "# Claude Code Test File" > issues/claude-outputs/test-${{ steps.issue.outputs.number }}.md
          echo "" >> issues/claude-outputs/test-${{ steps.issue.outputs.number }}.md
          echo "Issue #${{ steps.issue.outputs.number }}: ${{ steps.issue.outputs.title }}" >> issues/claude-outputs/test-${{ steps.issue.outputs.number }}.md
          echo "" >> issues/claude-outputs/test-${{ steps.issue.outputs.number }}.md
          echo "Generated at: $(date)" >> issues/claude-outputs/test-${{ steps.issue.outputs.number }}.md
          echo "" >> issues/claude-outputs/test-${{ steps.issue.outputs.number }}.md
          echo "This file was automatically generated by Claude Code GitHub Action." >> issues/claude-outputs/test-${{ steps.issue.outputs.number }}.md
    
      - name: Commit changes
        run: |
          echo "=== Git Status ==="
          git status
          echo "=== Git Diff ==="
          git diff --name-only
          echo "=== Untracked Files ==="
          git ls-files --others --exclude-standard
          
          if [[ -n $(git status -s) ]]; then
            echo "å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™..."
            git add .
            git commit -m "feat: Issue #${{ steps.issue.outputs.number }} ã®å®Ÿè£…

            ${{ steps.issue.outputs.title }}
            
            Co-authored-by: Claude <claude-code[bot]@users.noreply.github.com>"
            git push origin ${{ env.branch_name }}
            echo "ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
          else
            echo "âš ï¸ å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚"
            echo "å¼·åˆ¶çš„ã«ãƒ€ãƒŸãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™ã€‚"
            echo "# Claude Code Test - Issue #${{ steps.issue.outputs.number }}" > claude-code-test.md
            echo "Created at: $(date)" >> claude-code-test.md
            git add claude-code-test.md
            git commit -m "feat: Issue #${{ steps.issue.outputs.number }} ã®å®Ÿè£…ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰

            ${{ steps.issue.outputs.title }}
            
            Co-authored-by: Claude <claude-code[bot]@users.noreply.github.com>"
            git push origin ${{ env.branch_name }}
            echo "ãƒ€ãƒŸãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
          fi
      
      - name: Create pull request
        if: success()
        run: |
          PR_BODY="## æ¦‚è¦
          Issue #${{ steps.issue.outputs.number }} ã®è‡ªå‹•å®Ÿè£…
          
          ### å®Ÿè£…å†…å®¹
          ${{ steps.issue.outputs.title }}
          
          ### é–¢é€£Issue
          Closes #${{ steps.issue.outputs.number }}
          
          ### ãƒ†ã‚¹ãƒˆ
          - [ ] å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          - [ ] çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          - [ ] æ‰‹å‹•ãƒ†ã‚¹ãƒˆå®Œäº†"
          
          PR_URL=$(gh pr create \
            --title "feat: Issue #${{ steps.issue.outputs.number }} - ${{ steps.issue.outputs.title }}" \
            --body "$PR_BODY" \
            --base main \
            --head ${{ env.branch_name }} \
            --assignee ${{ github.actor }})
          
          echo "pr_url=$PR_URL" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
      
      - name: Post comment response
        if: success() && github.event_name == 'issue_comment'
        run: |
          COMMENT_BODY="ğŸ‘‹ @${{ github.actor }} ã•ã‚“ã€Claude Code ãŒå¯¾å¿œã„ãŸã—ã¾ã™ï¼

          ## ğŸš€ å®Ÿè¡Œçµæœ
          - âœ… ãƒ–ãƒ©ãƒ³ãƒä½œæˆ: \`${{ env.branch_name }}\`
          - âœ… å®Ÿè£…å®Œäº†: Issue #${{ steps.issue.outputs.number }} ã®å†…å®¹ã‚’å®Ÿè£…ã—ã¾ã—ãŸ
          - âœ… PRä½œæˆ: ${{ env.pr_url }}

          ## ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          1. ä½œæˆã•ã‚ŒãŸPRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„
          2. å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã‚’è¡Œã£ã¦ãã ã•ã„  
          3. å•é¡Œãªã‘ã‚Œã°ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„

          ## ğŸ¤– Claude Code ã«ã¤ã„ã¦
          Claude Code ã¯ @claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
          
          ---
          *ğŸ¤– ã“ã®è¿”ä¿¡ã¯ Claude Code GitHub Action ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*"

          gh issue comment ${{ steps.issue.outputs.number }} --body "$COMMENT_BODY"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}