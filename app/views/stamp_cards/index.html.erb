<% content_for :title, "スタンプカード" %>

<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">📅 ラジオ体操スタンプカード</h1>
        <div class="d-flex gap-2">
          <%= link_to "📊 詳細統計", statistics_path, class: "btn btn-info" %>
          <%= link_to "ログアウト", destroy_user_session_path, method: :delete, 
                      class: "btn btn-outline-secondary" %>
        </div>
      </div>
    </div>
  </div>

  <!-- スタンプ押印ボタン -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center">
          <% if @stamped_today %>
            <h4 class="text-success">✅ 今日のスタンプは押印済みです！</h4>
            <p class="text-muted">明日もがんばりましょう！</p>
          <% else %>
            <h4>🌅 今日のラジオ体操はお疲れ様でした！</h4>
            <p class="mb-3">スタンプを押して記録しましょう</p>
            <%= form_with url: stamp_cards_path, method: :post, local: true do |f| %>
              <%= f.submit "✋ スタンプを押す", class: "btn btn-primary btn-lg" %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- スタンプカード画像表示 -->
  <div class="row">
    <!-- スタンプカード部分 -->
    <div class="col-lg-9 col-md-8 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">📅 <%= @current_month.strftime("%Y年%m月") %> のスタンプ記録</h5>
        </div>
        <div class="card-body">
          <div class="stamp-card-container">
            <!-- 背景のスタンプカード画像 -->
            <div class="stamp-card-background">
              <%= image_tag "cards/stamp_card.png", class: "stamp-card-image", alt: "ラジオ体操カード" %>
            </div>
            
            <!-- 各日付のスタンプを重ねる -->
            <div class="stamp-overlay">
              <% @calendar_days.each_with_index do |week, week_index| %>
                <% week.each_with_index do |day, day_index| %>
                  <% if day[:current_month] %>
                    <div class="stamp-position" 
                         data-week="<%= week_index %>" 
                         data-day="<%= day_index %>"
                         data-date="<%= day[:date].day %>">
                      <% if day[:stamped] %>
                        <%= image_tag "stamps/heart_stamp.svg", class: "actual-stamp", alt: "参加済み" %>
                      <% end %>
                      <% if day[:date] == Date.current %>
                        <span class="today-indicator">今日</span>
                      <% end %>
                    </div>
                  <% end %>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 空白スペース -->
    <div class="col-lg-3 col-md-4"></div>
  </div>
  
  <!-- 統計情報部分 -->
  <div class="row mt-4">
    <div class="col-12">
      <h3 class="mb-3">📊 あなたの統計情報</h3>
    </div>
    <!-- 連続日数 -->
    <div class="col-lg-4 col-md-4 col-sm-6 mb-4">
      <div class="card text-center h-100">
        <div class="card-body">
          <h5 class="card-title">🔥 連続日数</h5>
          <h2 class="text-warning"><%= @consecutive_days %> 日</h2>
        </div>
      </div>
    </div>
    
    <!-- 総スタンプ数 -->
    <div class="col-lg-4 col-md-4 col-sm-6 mb-4">
      <div class="card text-center h-100">
        <div class="card-body">
          <h5 class="card-title">⭐ 総スタンプ数</h5>
          <h2 class="text-success"><%= @total_stamps %> 個</h2>
        </div>
      </div>
    </div>
    
    <!-- 今月の参加率 -->
    <div class="col-lg-4 col-md-4 col-sm-12 mb-4">
      <div class="card text-center h-100">
        <div class="card-body">
          <h5 class="card-title">📊 今月の参加率</h5>
          <% participation_rate = (@total_stamps > 0) ? ((@total_stamps.to_f / Date.current.day) * 100).round(1) : 0 %>
          <h2 class="text-primary"><%= participation_rate %>%</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- 最近のスタンプ記録 -->
  <% if @stamp_cards.any? %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">📋 最近のスタンプ記録</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>日付</th>
                    <th>スタンプ時刻</th>
                    <th>曜日</th>
                  </tr>
                </thead>
                <tbody>
                  <% @stamp_cards.limit(10).each do |stamp| %>
                    <tr>
                      <td><%= stamp.date.strftime("%Y年%m月%d日") %></td>
                      <td><%= stamp.stamped_at.strftime("%H:%M") %></td>
                      <td><%= %w[日 月 火 水 木 金 土][stamp.date.wday] %>曜日</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<style>
.calendar-day {
  height: 80px;
  vertical-align: middle;
  position: relative;
}
.card {
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  border: 1px solid rgba(0, 0, 0, 0.125);
}
.today-marker {
  position: relative;
  z-index: 2;
}
</style>