<% content_for :title, "ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰" %>

<div class="container-fluid mt-4">
  <!-- ã‚¹ã‚¿ãƒ³ãƒ—æŠ¼å°ãƒœã‚¿ãƒ³ -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center">
          <% if @stamped_today %>
            <h4 class="text-success">âœ… ä»Šæ—¥ã®ã‚¹ã‚¿ãƒ³ãƒ—ã¯æŠ¼å°æ¸ˆã¿ã§ã™ï¼</h4>
            <p class="text-muted">æ˜æ—¥ã‚‚ãŒã‚“ã°ã‚Šã¾ã—ã‚‡ã†ï¼</p>
          <% else %>
            <h4>ğŸŒ… ä»Šæ—¥ã®ãƒ©ã‚¸ã‚ªä½“æ“ã¯ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</h4>
            <p class="mb-3">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŠ¼ã—ã¦è¨˜éŒ²ã—ã¾ã—ã‚‡ã†</p>
            <%= form_with url: stamp_cards_path, method: :post, local: true do |f| %>
              <%= f.submit "âœ‹ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŠ¼ã™", class: "btn btn-primary btn-lg" %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="alert alert-info">
        <strong>ğŸ’ª <%= encouragement_message(@consecutive_days) %></strong>
      </div>
    </div>
  </div>

  <!-- ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ç”»åƒè¡¨ç¤º + çµ±è¨ˆæƒ…å ± -->
  <div class="row">
    <!-- ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰éƒ¨åˆ† -->
    <div class="col-lg-8 col-md-7 mb-4">
      <div class="card">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
          <h6 class="mb-0 text-muted">ğŸ“… <%= format_month_display(@current_month) %> ã®ã‚¹ã‚¿ãƒ³ãƒ—è¨˜éŒ²</h6>
          <!-- æœˆé–“ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
          <div class="month-navigation">
            <%= month_navigation_link(@previous_month, :previous) %>
            <span class="mx-2">|</span>
            <%= month_navigation_link(@next_month, :next) %>
          </div>
        </div>
        <div class="card-body py-3">
          <div class="stamp-card-container">
            <!-- èƒŒæ™¯ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ç”»åƒ -->
            <div class="stamp-card-background">
              <%= image_tag "cards/stamp_card.png", class: "stamp-card-image", alt: "ãƒ©ã‚¸ã‚ªä½“æ“ã‚«ãƒ¼ãƒ‰" %>
            </div>
            
            <!-- æœˆãƒ»å¹´ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
            <div class="month-year-overlay">
              <div class="calendar-year"><%= format_year_display(@current_month) %></div>
              <div class="calendar-month-number"><%= format_month_number(@current_month) %></div>
              <div class="calendar-month-text">æœˆ</div>
              <div class="calendar-user-name"><%= current_user.email.split('@').first %></div>
            </div>
            
            <!-- æ—¥ä»˜ãƒ»ã‚¹ã‚¿ãƒ³ãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
            <div class="stamp-overlay">
              <% @calendar_days.each_with_index do |week, week_index| %>
                <% week.each_with_index do |day, day_index| %>
                  <div class="stamp-position <%= calendar_day_classes(day) %>" 
                       data-week="<%= week_index %>" 
                       data-day="<%= day_index %>"
                       data-date="<%= day[:date].day %>">
                    
                    <!-- å¸¸ã«æ—¥ä»˜æ•°å­—ã‚’è¡¨ç¤º -->
                    <div class="date-number">
                      <%= format_day_number(day[:date]) %>
                    </div>
                    
                    <% if day[:stamped] %>
                      <!-- ã‚¹ã‚¿ãƒ³ãƒ—æ¸ˆã¿ã®æ—¥ã«ã¯ã‚¹ã‚¿ãƒ³ãƒ—ç”»åƒã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
                      <div class="stamp-overlay-image">
                        <div class="participation-stamp">æ–‰</div>
                      </div>
                    <% end %>
                    
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- çµ±è¨ˆæƒ…å ±éƒ¨åˆ† -->
    <div class="col-lg-4 col-md-5 mb-4">
      <div class="statistics-sidebar" style="display: flex; flex-direction: column; gap: 30px; height: 100%;">
        <!-- é€£ç¶šæ—¥æ•° -->
        <div class="card text-center" style="flex: 1; min-height: 150px;">
          <div class="card-body" style="padding: 2rem; display: flex; flex-direction: column; justify-content: center;">
            <h5 class="card-title" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">ğŸ”¥ é€£ç¶šæ—¥æ•°</h5>
            <h2 class="text-warning" style="font-size: 3rem; font-weight: bold; margin: 0;"><%= @consecutive_days %> æ—¥</h2>
          </div>
        </div>
        
        <!-- ç·ã‚¹ã‚¿ãƒ³ãƒ—æ•° -->
        <div class="card text-center" style="flex: 1; min-height: 150px;">
          <div class="card-body" style="padding: 2rem; display: flex; flex-direction: column; justify-content: center;">
            <h5 class="card-title" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">â­ ç·ã‚¹ã‚¿ãƒ³ãƒ—æ•°</h5>
            <h2 class="text-success" style="font-size: 3rem; font-weight: bold; margin: 0;"><%= @total_stamps %> å€‹</h2>
          </div>
        </div>
        
        <!-- ä»Šæœˆã®å‚åŠ ç‡ -->
        <div class="card text-center" style="flex: 1; min-height: 150px;">
          <div class="card-body" style="padding: 2rem; display: flex; flex-direction: column; justify-content: center;">
            <h5 class="card-title" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">ğŸ“Š ä»Šæœˆã®å‚åŠ ç‡</h5>
            <h2 class="<%= participation_rate_color_class(@monthly_participation_rate) %>" style="font-size: 3rem; font-weight: bold; margin: 0;"><%= @monthly_participation_rate %>%</h2>
            <small class="text-muted">(<%= @monthly_stamps %>æ—¥å‚åŠ )</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æœ€è¿‘ã®ã‚¹ã‚¿ãƒ³ãƒ—è¨˜éŒ² -->
  <% if @stamp_cards.any? %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">ğŸ“‹ æœ€è¿‘ã®ã‚¹ã‚¿ãƒ³ãƒ—è¨˜éŒ²</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>æ—¥ä»˜</th>
                    <th>ã‚¹ã‚¿ãƒ³ãƒ—æ™‚åˆ»</th>
                    <th>æ›œæ—¥</th>
                  </tr>
                </thead>
                <tbody>
                  <% @stamp_cards.limit(10).each do |stamp| %>
                    <tr>
                      <td><%= stamp.date.strftime("%Yå¹´%mæœˆ%dæ—¥") %></td>
                      <td><%= stamp.stamped_at.strftime("%H:%M") %></td>
                      <td><%= %w[æ—¥ æœˆ ç« æ°´ æœ¨ é‡‘ åœŸ][stamp.date.wday] %>æ›œæ—¥</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<style>
/* ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ç”»åƒã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å°‚ç”¨ã®æ—¥ä»˜ä¸­å¤®é…ç½® */
.stamp-card-container {
  position: relative;
  display: inline-block;
  width: 100%;
}

.stamp-card-background {
  position: relative;
  width: 100%;
}

.stamp-card-image {
  width: 100%;
  height: auto;
  display: block;
}

/* CSS Gridã‚’ç„¡åŠ¹åŒ– - application.scssã®åº§æ¨™æŒ‡å®šã‚’å„ªå…ˆ */
.stamp-overlay {
  /* application.scssã§å®šç¾©æ¸ˆã¿ã®ãŸã‚ç„¡åŠ¹åŒ– */
}

/* stamp-positionã‚‚application.scssã§å®šç¾©æ¸ˆã¿ã®ãŸã‚ç„¡åŠ¹åŒ– */
.stamp-position {
  /* application.scssã§è©³ç´°ã«å®šç¾©æ¸ˆã¿ */
}

.stamp-position .date-number {
  position: relative !important;
  z-index: 100 !important;
  font-weight: bold !important;
  font-size: 1.2rem !important;
  color: white !important;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.7) !important;
  pointer-events: none;
}

/* ã‚¹ã‚¿ãƒ³ãƒ—ç”»åƒã¯æ—¥ä»˜ä½ç½®ã«å½±éŸ¿ã•ã›ãªã„ */
.stamp-position .stamp-overlay-image {
  position: absolute !important;
  top: 50% !important;
  left: 50% !important;
  transform: translate(-50%, 15px) !important;
  z-index: 50 !important;
}

.stamp-position .participation-stamp {
  background: rgba(255, 215, 0, 0.9);
  color: #d4691b;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 0.8rem;
  border: 2px solid #d4691b;
}

.card {
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  border: 1px solid rgba(0, 0, 0, 0.125);
}

.today-marker {
  position: relative;
  z-index: 2;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
  .stamp-overlay {
    top: 17%;
    left: 3%;
    width: 94%;
    height: 72%;
  }
  
  .stamp-position .date-number {
    font-size: 1rem !important;
  }
  
  .stamp-position .participation-stamp {
    width: 16px;
    height: 16px;
    font-size: 0.7rem;
  }
}

@media (max-width: 576px) {
  .stamp-overlay {
    top: 15%;
    left: 2%;
    width: 96%;
    height: 74%;
  }
  
  .stamp-position .date-number {
    font-size: 0.9rem !important;
  }
  
  .stamp-position .participation-stamp {
    width: 14px;
    height: 14px;
    font-size: 0.6rem;
  }
}
</style>