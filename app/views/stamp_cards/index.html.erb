<% content_for :title, "ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰" %>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center mb-4 gap-3">
        <h1 class="h2 mb-0">ğŸ“… ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰</h1>
        <div class="d-flex flex-wrap gap-2" role="navigation" aria-label="ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
          <%= link_to "ğŸ“Š çµ±è¨ˆ", statistics_path, 
                      class: "btn btn-outline-primary btn-sm",
                      "aria-label": "çµ±è¨ˆæƒ…å ±ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º" %>
          <%= link_to "ğŸ† ãƒãƒƒã‚¸", badges_path, 
                      class: "btn btn-outline-info btn-sm",
                      "aria-label": "ç²å¾—ãƒãƒƒã‚¸ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º" %>
          <% if current_user.admin? %>
            <%= link_to "ğŸ¯ ç®¡ç†", admin_root_path, 
                        class: "btn btn-outline-secondary btn-sm",
                        "aria-label": "ç®¡ç†ç”»é¢ã‚’è¡¨ç¤º" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- æœˆé–“çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 col-md-3 mb-3">
              <h6 class="text-primary mb-1">ğŸ“… ä»Šæœˆã®å‚åŠ </h6>
              <h4><%= @monthly_stats[:total_stamps] %>/<%= @monthly_stats[:days_passed] %>æ—¥</h4>
              <small class="text-muted">å‚åŠ ç‡: <%= @monthly_stats[:participation_rate] %>%</small>
            </div>
            <div class="col-6 col-md-3 mb-3">
              <h6 class="text-success mb-1">â­ ç·å‚åŠ æ—¥æ•°</h6>
              <h4><%= @user_stats[:total_stamps] %>æ—¥</h4>
            </div>
            <div class="col-6 col-md-3 mb-3">
              <h6 class="text-warning mb-1">ğŸ”¥ é€£ç¶šæ—¥æ•°</h6>
              <h4><%= @user_stats[:consecutive_days] %>æ—¥</h4>
            </div>
            <div class="col-6 col-md-3 mb-3">
              <h6 class="text-info mb-1">ğŸ† æœ€é•·è¨˜éŒ²</h6>
              <h4><%= @user_stats[:longest_streak] %>æ—¥</h4>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æœˆé–“ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-3 gap-2">
            <% prev_month = @monthly_stats[:month] - 1.month %>
            <%= link_to stamp_cards_path(year: prev_month.year, month: prev_month.month), 
                        class: "btn btn-outline-primary btn-sm order-1 order-md-0",
                        "aria-label": "å‰æœˆï¼ˆ#{prev_month.strftime('%Yå¹´%mæœˆ')}ï¼‰ã‚’è¡¨ç¤º" do %>
              <i class="bi bi-chevron-left" aria-hidden="true"></i> 
              <span class="d-none d-sm-inline"><%= prev_month.strftime("%Yå¹´%mæœˆ") %></span>
              <span class="d-sm-none">å‰æœˆ</span>
            <% end %>
            
            <h4 class="mb-0 order-0 order-md-1 text-center">
              <%= @monthly_stats[:month].strftime("%Yå¹´%mæœˆ") %>ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰
            </h4>
            
            <% next_month = @monthly_stats[:month] + 1.month %>
            <% if next_month <= Date.current.beginning_of_month %>
              <%= link_to stamp_cards_path(year: next_month.year, month: next_month.month), 
                          class: "btn btn-outline-primary btn-sm order-2",
                          "aria-label": "æ¬¡æœˆï¼ˆ#{next_month.strftime('%Yå¹´%mæœˆ')}ï¼‰ã‚’è¡¨ç¤º" do %>
                <span class="d-none d-sm-inline"><%= next_month.strftime("%Yå¹´%mæœˆ") %></span>
                <span class="d-sm-none">æ¬¡æœˆ</span>
                <i class="bi bi-chevron-right" aria-hidden="true"></i>
              <% end %>
            <% else %>
              <span class="btn btn-outline-secondary disabled btn-sm order-2"
                    aria-label="æ¬¡æœˆï¼ˆ#{next_month.strftime('%Yå¹´%mæœˆ')}ï¼‰ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“">
                <span class="d-none d-sm-inline"><%= next_month.strftime("%Yå¹´%mæœˆ") %></span>
                <span class="d-sm-none">æ¬¡æœˆ</span>
                <i class="bi bi-chevron-right" aria-hidden="true"></i>
              </span>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ©ã‚¸ã‚ªä½“æ“ã‚«ãƒ¼ãƒ‰è¡¨ç¤º -->
  <div class="row mb-4">
    <div class="col-lg-8 col-xl-6 mx-auto">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">ğŸ“… ãƒ©ã‚¸ã‚ªä½“æ“ã‚«ãƒ¼ãƒ‰</h5>
        </div>
        <div class="card-body text-center">
          <div class="stamp-card-container">
            <% 
              # app/assets/images ã‚’å„ªå…ˆã—ã¦PNGå½¢å¼ã‚’ä½¿ç”¨
              image_file = ["radio_calisthenics_card.png", "radio_calisthenics_card.jpg"].find do |file|
                Rails.application.assets&.find_asset(file) || 
                File.exist?(Rails.root.join("app", "assets", "images", file))
              end
              image_file ||= "radio_calisthenics_card.png" # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯PNG
            %>
            <%= image_tag image_file, 
                          alt: "ãƒ©ã‚¸ã‚ªä½“æ“ã‚«ãƒ¼ãƒ‰", 
                          class: "img-fluid border rounded",
                          style: "max-width: 600px; width: 100%; height: auto;" %>
          </div>
          <div class="mt-3">
            <small class="text-muted">
              ãƒ©ã‚¸ã‚ªä½“æ“å‚åŠ ã‚«ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ - ç¶™ç¶šã¯åŠ›ãªã‚Šï¼
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ä»Šæ—¥ã®ã‚¹ã‚¿ãƒ³ãƒ— -->
  <% if @monthly_stats[:can_stamp_today] %>
    <div class="row mb-4">
      <div class="col-12">
        <div class="card border-primary">
          <div class="card-body text-center">
            <h5 class="card-title text-primary">ä»Šæ—¥ã®ãƒ©ã‚¸ã‚ªä½“æ“ã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ</h5>
            <p class="card-text">ä»Šæ—¥ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŠ¼ã—ã¦è¨˜éŒ²ã‚’æ®‹ã—ã¾ã—ã‚‡ã†ï¼</p>
            <%= form_with model: StampCard.new, url: stamp_cards_path, class: "d-inline" do |form| %>
              <%= form.hidden_field :date, value: Date.current %>
              <%= form.submit "ğŸ“… ä»Šæ—¥ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŠ¼ã™", 
                              class: "btn btn-primary btn-lg",
                              "aria-label": "ä»Šæ—¥ã®æ—¥ä»˜ï¼ˆ#{Date.current.strftime('%Yå¹´%mæœˆ%dæ—¥')}ï¼‰ã«ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¨˜éŒ²",
                              data: { confirm: "ä»Šæ—¥ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŠ¼ã—ã¾ã™ã‹ï¼Ÿ" } %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆ -->
  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">ğŸ† ã‚ãªãŸã®è¨˜éŒ²</h5>
        </div>
        <div class="card-body">
          <ul class="list-unstyled mb-0">
            <li class="mb-2">
              <strong>ç·å‚åŠ æ—¥æ•°:</strong> <%= @user_stats[:total_stamps] %>æ—¥
            </li>
            <li class="mb-2">
              <strong>ç¾åœ¨ã®é€£ç¶šæ—¥æ•°:</strong> <%= @user_stats[:consecutive_days] %>æ—¥
            </li>
            <li class="mb-2">
              <strong>æœ€é•·é€£ç¶šè¨˜éŒ²:</strong> <%= @user_stats[:longest_streak] %>æ—¥
            </li>
            <li class="mb-2">
              <strong>ä»Šæœˆã®å‚åŠ :</strong> <%= @user_stats[:stamps_this_month] %>æ—¥
            </li>
            <li class="mb-2">
              <strong>ä»Šå¹´ã®å‚åŠ :</strong> <%= @user_stats[:stamps_this_year] %>æ—¥
            </li>
            <% if @user_stats[:average_time] %>
              <li>
                <strong>å¹³å‡å‚åŠ æ™‚åˆ»:</strong> <%= @user_stats[:average_time] %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">ğŸ’ª å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h5>
        </div>
        <div class="card-body">
          <% if @user_stats[:consecutive_days] >= 30 %>
            <p class="text-success mb-0">
              <strong>ç´ æ™´ã‚‰ã—ã„ï¼</strong><br>
              <%= @user_stats[:consecutive_days] %>æ—¥é€£ç¶šå‚åŠ ã¯æœ¬å½“ã«ç«‹æ´¾ã§ã™ï¼ç¶™ç¶šã¯åŠ›ãªã‚Šã§ã™ã­ã€‚
            </p>
          <% elsif @user_stats[:consecutive_days] >= 7 %>
            <p class="text-primary mb-0">
              <strong>ãŠç–²ã‚Œæ§˜ï¼</strong><br>
              <%= @user_stats[:consecutive_days] %>æ—¥é€£ç¶šå‚åŠ ä¸­ã§ã™ã€‚ã“ã®èª¿å­ã§ç¶šã‘ã¦ã„ãã¾ã—ã‚‡ã†ï¼
            </p>
          <% elsif @user_stats[:consecutive_days] > 0 %>
            <p class="text-info mb-0">
              <strong>ã„ã„ãƒšãƒ¼ã‚¹ã§ã™ï¼</strong><br>
              <%= @user_stats[:consecutive_days] %>æ—¥é€£ç¶šå‚åŠ ä¸­ã€‚ç¿’æ…£åŒ–ã¾ã§ã‚ã¨å°‘ã—ã§ã™ã€‚
            </p>
          <% else %>
            <p class="text-muted mb-0">
              <strong>ä»Šæ—¥ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ï¼</strong><br>
              ãƒ©ã‚¸ã‚ªä½“æ“ã§å¥åº·çš„ãªæ¯æ—¥ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã›ã‚“ã‹ï¼Ÿ
            </p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºæœ€é©åŒ– */
  .stamp-card-container {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1.25rem;
  }
  
  .stamp-card-container img {
    box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.1);
    transition: transform 0.2s ease-in-out;
    will-change: transform;
  }
  
  .stamp-card-container img:hover {
    transform: scale(1.02);
  }
  
  /* ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
  @media (max-width: 576px) {
    .stamp-card-container {
      padding: 1rem;
    }
    
    .container {
      padding-left: 0.75rem;
      padding-right: 0.75rem;
    }
  }
  
  /* ãƒ—ãƒªãƒ³ãƒˆæœ€é©åŒ– */
  @media print {
    .btn, nav, .d-print-none {
      display: none !important;
    }
    
    .stamp-card-container img {
      box-shadow: none;
      max-width: 100% !important;
    }
  }
  
  /* ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– */
  .card {
    will-change: auto;
  }
  
  .btn {
    will-change: auto;
  }
</style>