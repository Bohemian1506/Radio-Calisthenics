<% content_for :title, "スタンプカード" %>

<div class="container mt-4">

  <!-- メインコンテンツ：2カラムレイアウト -->
  <div class="row mb-4 align-items-start">
    <!-- ラジオ体操カード表示（左側） -->
    <div class="col-lg-7 mb-4">
      <div class="card" style="height: 1000px !important;">
        <div class="card-header" style="min-height: 4rem;">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-2 h-100">
            <% prev_month = @monthly_stats[:month] - 1.month %>
            <%= link_to stamp_cards_path(year: prev_month.year, month: prev_month.month), 
                        class: "btn btn-outline-primary btn-sm order-1 order-md-0",
                        "aria-label": "前月（#{prev_month.strftime('%Y年%m月')}）を表示" do %>
              <i class="bi bi-chevron-left" aria-hidden="true"></i> 
              <span class="d-none d-sm-inline"><%= prev_month.strftime("%Y年%m月") %></span>
              <span class="d-sm-none">前月</span>
            <% end %>
            
            <h5 class="mb-0 order-0 order-md-1 text-center">📅 ラジオ体操カード</h5>
            
            <% next_month = @monthly_stats[:month] + 1.month %>
            <% if next_month <= Date.current.beginning_of_month %>
              <%= link_to stamp_cards_path(year: next_month.year, month: next_month.month), 
                          class: "btn btn-outline-primary btn-sm order-2",
                          "aria-label": "次月（#{next_month.strftime('%Y年%m月')}）を表示" do %>
                <span class="d-none d-sm-inline"><%= next_month.strftime("%Y年%m月") %></span>
                <span class="d-sm-none">次月</span>
                <i class="bi bi-chevron-right" aria-hidden="true"></i>
              <% end %>
            <% else %>
              <span class="btn btn-outline-secondary disabled btn-sm order-2"
                    aria-label="次月（#{next_month.strftime('%Y年%m月')}）は利用できません">
                <span class="d-none d-sm-inline"><%= next_month.strftime("%Y年%m月") %></span>
                <span class="d-sm-none">次月</span>
                <i class="bi bi-chevron-right" aria-hidden="true"></i>
              </span>
            <% end %>
          </div>
        </div>
        <div class="card-body text-center d-flex flex-column justify-content-center">
          <div class="stamp-card-container position-relative">
            <% 
              # app/assets/images を優先してPNG形式を使用
              image_file = ["radio_calisthenics_card.png", "radio_calisthenics_card.jpg"].find do |file|
                Rails.application.assets&.find_asset(file) || 
                File.exist?(Rails.root.join("app", "assets", "images", file))
              end
              image_file ||= "radio_calisthenics_card.png" # デフォルトはPNG
            %>
            <%= image_tag image_file, 
                          alt: "ラジオ体操カード", 
                          class: "img-fluid border rounded",
                          style: "max-width: 100%; width: 100%; height: auto;" %>
            
            <!-- SVGオーバーレイ -->
            <svg class="position-absolute top-0 start-0 w-100 h-100" 
                 viewBox="0 0 800 600" 
                 preserveAspectRatio="xMidYMid meet"
                 style="pointer-events: none;">
              <!-- ユーザー名表示 -->
              <text x="460" y="-13" 
                    text-anchor="start" 
                    font-family="Arial, sans-serif" 
                    font-size="24" 
                    font-weight="bold" 
                    fill="#2c3e50">
                <%= current_user.email.split('@').first %>
              </text>
              
              <!-- 月の数字 -->
              <text x="100" y="0" 
                    text-anchor="middle" 
                    font-family="Arial, sans-serif" 
                    font-size="72" 
                    font-weight="bold" 
                    fill="#2c3e50">
                <%= @monthly_stats[:month].strftime("%-m") %>
              </text>
              
              <!-- カレンダーグリッドのスタンプ表示 -->
              <% 
                # カレンダーの開始位置とグリッドサイズ
                grid_start_x = 45
                grid_start_y = 180
                cell_width = 101
                cell_height = 100
              %>
              
              <!-- カレンダー日付とスタンプ -->
              <% @calendar_data.each_with_index do |week, week_index| %>
                <% week.each_with_index do |day_data, day_index| %>
                  <% 
                    # 6週目の同月日付は表示をスキップ
                    next if week_index == 5 && day_data[:current_month]
                  %>
                  <% if day_data[:current_month] %>
                    <% 
                      x_pos = grid_start_x + day_index * cell_width + cell_width / 2
                      y_pos = grid_start_y + week_index * cell_height + cell_height / 2
                      
                      # 6週目の日付を検出して前週の同じ曜日に表示するロジック
                      current_date = day_data[:date]
                      is_combined_cell = false
                      combined_dates = []
                      
                      # 5週目で、6週目に同じ曜日の同月日付がある場合
                      if week_index == 4 && day_data[:current_month]
                        # 6週目の同じ曜日（day_index）に同月の日付があるかチェック
                        sixth_week = @calendar_data[5] if @calendar_data.length > 5
                        if sixth_week && sixth_week[day_index] && sixth_week[day_index][:current_month]
                          sixth_week_date = sixth_week[day_index][:date]
                          is_combined_cell = true
                          combined_dates = [current_date.day, sixth_week_date.day]
                        end
                      end
                    %>
                    
                    <!-- 日付表示 -->
                    <% if is_combined_cell && combined_dates.any? %>
                      <!-- 複数日付の場合（斜めに配置） -->
                      <!-- 1つ目の日付（左上） -->
                      <text x="<%= x_pos - 25 %>" 
                            y="<%= y_pos - 18 %>" 
                            text-anchor="middle" 
                            font-family="Arial, sans-serif" 
                            font-size="28" 
                            font-weight="bold" 
                            fill="white">
                        <%= combined_dates[0] %>
                      </text>
                      <!-- スラッシュ（中央） -->
                      <text x="<%= x_pos %>" 
                            y="<%= y_pos %>" 
                            text-anchor="middle" 
                            font-family="Arial, sans-serif" 
                            font-size="24" 
                            font-weight="bold" 
                            fill="white" 
                            opacity="0.8">
                        /
                      </text>
                      <!-- 2つ目の日付（右下） -->
                      <text x="<%= x_pos + 25 %>" 
                            y="<%= y_pos + 18 %>" 
                            text-anchor="middle" 
                            font-family="Arial, sans-serif" 
                            font-size="28" 
                            font-weight="bold" 
                            fill="white">
                        <%= combined_dates[1] %>
                      </text>
                    <% else %>
                      <!-- 単一日付の場合 -->
                      <text x="<%= x_pos %>" 
                            y="<%= y_pos %>" 
                            text-anchor="middle" 
                            font-family="Arial, sans-serif" 
                            font-size="48" 
                            font-weight="bold" 
                            fill="white">
                        <%= day_data[:date].day %>
                      </text>
                    <% end %>
                    
                    <!-- スタンプ表示（日付の上に重ねる） -->
                    <% if is_combined_cell && combined_dates.any? %>
                      <!-- 複数日付のスタンプ処理 -->
                      <% 
                        # 6週目の日付のスタンプ状態を取得
                        date1_stamped = day_data[:stamped]
                        date2_stamped = sixth_week_data[:stamped] if sixth_week_data
                      %>
                      
                      <!-- 1つ目の日付のスタンプ -->
                      <% if date1_stamped %>
                        <image href="<%= asset_path('stamp_completed.png') %>" 
                               x="<%= x_pos - 50 %>" 
                               y="<%= y_pos - 63 %>" 
                               width="50" 
                               height="50"
                               opacity="0.8"
                               transform="rotate(-5 <%= x_pos - 25 %> <%= y_pos - 18 %>)"
                               class="stamp-image">
                          <title><%= current_date.strftime("%m月%d日") %>: スタンプ済み</title>
                        </image>
                      <% end %>
                      
                      <!-- 2つ目の日付のスタンプ -->
                      <% if date2_stamped %>
                        <image href="<%= asset_path('stamp_completed.png') %>" 
                               x="<%= x_pos %>" 
                               y="<%= y_pos - 27 %>" 
                               width="50" 
                               height="50"
                               opacity="0.8"
                               transform="rotate(-5 <%= x_pos + 25 %> <%= y_pos + 18 %>)"
                               class="stamp-image">
                          <title><%= sixth_week_data[:date].strftime("%m月%d日") %>: スタンプ済み</title>
                        </image>
                      <% end %>
                    <% else %>
                      <!-- 単一日付のスタンプ -->
                      <% if day_data[:stamped] %>
                        <image href="<%= asset_path('stamp_completed.png') %>" 
                               x="<%= x_pos - 40 %>" 
                               y="<%= y_pos - 60 %>" 
                               width="80" 
                               height="80"
                               opacity="0.8"
                               transform="rotate(-5 <%= x_pos %> <%= y_pos %>)"
                               class="stamp-image">
                          <title><%= day_data[:date].strftime("%m月%d日") %>: スタンプ済み（<%= day_data[:stamped_time] %>）</title>
                        </image>
                      <% elsif day_data[:can_stamp] %>
                        <!-- 押せる日のヒント -->
                        <circle cx="<%= x_pos %>" cy="<%= y_pos %>" 
                                r="40" 
                                fill="none" 
                                stroke="#dc3545"
                                stroke-width="2"
                                stroke-dasharray="5,5"
                                opacity="0.3"
                                class="stamp-hint">
                          <title><%= day_data[:date].strftime("%m月%d日") %>: スタンプ可能</title>
                        </circle>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- 月間統計サマリー（右側） -->
    <div class="col-lg-5">
      <div class="card" style="height: 1000px !important;">
        <div class="card-header d-flex align-items-center" style="min-height: 4rem;">
          <h5 class="mb-0">📊 今日のスタンプ・記録</h5>
        </div>
        <div class="card-body d-flex flex-column" style="overflow-y: auto; padding-top: 1.5rem;">
          <div class="d-flex flex-column gap-2">
            <!-- 今日のスタンプ -->
            <% if @monthly_stats[:can_stamp_today] %>
              <div class="text-center p-3 border rounded border-primary bg-primary bg-opacity-10">
                <h6 class="card-title text-primary mb-2">今日のラジオ体操はいかがでしたか？</h6>
                <p class="card-text mb-3">今日のスタンプを押して記録を残しましょう！</p>
                <%= form_with model: StampCard.new, url: stamp_cards_path, class: "d-inline" do |form| %>
                  <%= form.hidden_field :date, value: Date.current %>
                  <%= form.submit "📅 今日のスタンプを押す", 
                                  class: "btn btn-primary",
                                  "aria-label": "今日の日付（#{Date.current.strftime('%Y年%m月%d日')}）にスタンプを記録",
                                  data: { confirm: "今日のスタンプを押しますか？" } %>
                <% end %>
              </div>
            <% end %>
            
            <!-- 基本統計 -->
            <div class="text-center p-3 border rounded bg-light">
              <h6 class="text-primary mb-2">📅 今月の参加</h6>
              <h3 class="mb-1"><%= @monthly_stats[:total_stamps] %>/<%= @monthly_stats[:days_passed] %>日</h3>
              <div class="text-muted">参加率: <%= @monthly_stats[:participation_rate] %>%</div>
            </div>
            
            <div class="text-center p-3 border rounded bg-light">
              <h6 class="text-success mb-2">⭐ 総参加日数</h6>
              <h3 class="mb-0"><%= @user_stats[:total_stamps] %>日</h3>
            </div>
            
            <div class="text-center p-3 border rounded bg-light">
              <h6 class="text-warning mb-2">🔥 連続日数</h6>
              <h3 class="mb-0"><%= @user_stats[:consecutive_days] %>日</h3>
            </div>
            
            <div class="text-center p-3 border rounded bg-light">
              <h6 class="text-info mb-2">🏆 最長記録</h6>
              <h3 class="mb-0"><%= @user_stats[:longest_streak] %>日</h3>
            </div>
            
            <!-- 詳細統計 -->
            <div class="border rounded p-3 bg-light">
              <h6 class="text-secondary mb-3">📈 詳細データ</h6>
              <div class="row g-2 text-center">
                <div class="col-6">
                  <small class="text-muted d-block mb-1">今年の参加</small>
                  <h5 class="mb-0"><%= @user_stats[:stamps_this_year] %>日</h5>
                </div>
                <% if @user_stats[:average_time] %>
                <div class="col-6">
                  <small class="text-muted d-block mb-1">平均時刻</small>
                  <h5 class="mb-0"><%= @user_stats[:average_time] %></h5>
                </div>
                <% end %>
              </div>
            </div>
            
            <!-- 応援メッセージ -->
            <div class="border rounded p-3 bg-gradient" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
              <h6 class="text-secondary mb-2">💪 応援メッセージ</h6>
              <% if @user_stats[:consecutive_days] >= 30 %>
                <p class="text-success mb-0">
                  <strong>素晴らしい！</strong><br>
                  <small><%= @user_stats[:consecutive_days] %>日連続参加は本当に立派です！</small>
                </p>
              <% elsif @user_stats[:consecutive_days] >= 7 %>
                <p class="text-primary mb-0">
                  <strong>お疲れ様！</strong><br>
                  <small><%= @user_stats[:consecutive_days] %>日連続参加中です。この調子で！</small>
                </p>
              <% elsif @user_stats[:consecutive_days] > 0 %>
                <p class="text-info mb-0">
                  <strong>いいペースです！</strong><br>
                  <small><%= @user_stats[:consecutive_days] %>日連続参加中。習慣化まであと少し！</small>
                </p>
              <% else %>
                <p class="text-muted mb-0">
                  <strong>今日から始めましょう！</strong><br>
                  <small>ラジオ体操で健康的な毎日をスタート！</small>
                </p>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

