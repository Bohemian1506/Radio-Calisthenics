<% content_for :title, "„Çπ„Çø„É≥„Éó„Ç´„Éº„Éâ" %>

<div class="container mt-4">

  <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºö2„Ç´„É©„É†„É¨„Ç§„Ç¢„Ç¶„Éà -->
  <div class="row mb-4 align-items-start">
    <!-- „É©„Ç∏„Ç™‰ΩìÊìç„Ç´„Éº„ÉâË°®Á§∫ÔºàÂ∑¶ÂÅ¥Ôºâ -->
    <div class="col-lg-7 mb-4">
      <div class="card" style="height: 1000px !important;">
        <div class="card-header" style="min-height: 4rem;">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-2 h-100">
            <% prev_month = @monthly_stats[:month] - 1.month %>
            <%= link_to stamp_cards_path(year: prev_month.year, month: prev_month.month), 
                        class: "btn btn-outline-primary btn-sm order-1 order-md-0",
                        "aria-label": "ÂâçÊúàÔºà#{prev_month.strftime('%YÂπ¥%mÊúà')}Ôºâ„ÇíË°®Á§∫" do %>
              <i class="bi bi-chevron-left" aria-hidden="true"></i> 
              <span class="d-none d-sm-inline"><%= prev_month.strftime("%YÂπ¥%mÊúà") %></span>
              <span class="d-sm-none">ÂâçÊúà</span>
            <% end %>
            
            <h5 class="mb-0 order-0 order-md-1 text-center">üìÖ „É©„Ç∏„Ç™‰ΩìÊìç„Ç´„Éº„Éâ</h5>
            
            <% next_month = @monthly_stats[:month] + 1.month %>
            <% if next_month <= Date.current.beginning_of_month %>
              <%= link_to stamp_cards_path(year: next_month.year, month: next_month.month), 
                          class: "btn btn-outline-primary btn-sm order-2",
                          "aria-label": "Ê¨°ÊúàÔºà#{next_month.strftime('%YÂπ¥%mÊúà')}Ôºâ„ÇíË°®Á§∫" do %>
                <span class="d-none d-sm-inline"><%= next_month.strftime("%YÂπ¥%mÊúà") %></span>
                <span class="d-sm-none">Ê¨°Êúà</span>
                <i class="bi bi-chevron-right" aria-hidden="true"></i>
              <% end %>
            <% else %>
              <span class="btn btn-outline-secondary disabled btn-sm order-2"
                    aria-label="Ê¨°ÊúàÔºà#{next_month.strftime('%YÂπ¥%mÊúà')}Ôºâ„ÅØÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì">
                <span class="d-none d-sm-inline"><%= next_month.strftime("%YÂπ¥%mÊúà") %></span>
                <span class="d-sm-none">Ê¨°Êúà</span>
                <i class="bi bi-chevron-right" aria-hidden="true"></i>
              </span>
            <% end %>
          </div>
        </div>
        <div class="card-body text-center d-flex flex-column justify-content-center">
          <div class="stamp-card-container position-relative">
            <% 
              # app/assets/images „ÇíÂÑ™ÂÖà„Åó„Å¶PNGÂΩ¢Âºè„Çí‰ΩøÁî®
              image_file = ["radio_calisthenics_card.png", "radio_calisthenics_card.jpg"].find do |file|
                Rails.application.assets&.find_asset(file) || 
                File.exist?(Rails.root.join("app", "assets", "images", file))
              end
              image_file ||= "radio_calisthenics_card.png" # „Éá„Éï„Ç©„É´„Éà„ÅØPNG
            %>
            <%= image_tag image_file, 
                          alt: "„É©„Ç∏„Ç™‰ΩìÊìç„Ç´„Éº„Éâ", 
                          class: "img-fluid border rounded",
                          style: "max-width: 100%; width: 100%; height: auto;" %>
            
            <!-- SVG„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
            <svg class="position-absolute top-0 start-0 w-100 h-100" 
                 viewBox="0 0 800 600" 
                 preserveAspectRatio="xMidYMid meet"
                 style="pointer-events: none;">
              <!-- „É¶„Éº„Ç∂„ÉºÂêçË°®Á§∫ -->
              <text x="460" y="-13" 
                    text-anchor="start" 
                    font-family="Arial, sans-serif" 
                    font-size="24" 
                    font-weight="bold" 
                    fill="#2c3e50">
                <%= current_user.email.split('@').first %>
              </text>
              
              <!-- Êúà„ÅÆÊï∞Â≠ó -->
              <text x="100" y="0" 
                    text-anchor="middle" 
                    font-family="Arial, sans-serif" 
                    font-size="72" 
                    font-weight="bold" 
                    fill="#2c3e50">
                <%= @monthly_stats[:month].strftime("%-m") %>
              </text>
              
              <!-- „Ç´„É¨„É≥„ÉÄ„Éº„Ç∞„É™„ÉÉ„Éâ„ÅÆ„Çπ„Çø„É≥„ÉóË°®Á§∫ -->
              <% 
                # „Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÈñãÂßã‰ΩçÁΩÆ„Å®„Ç∞„É™„ÉÉ„Éâ„Çµ„Ç§„Ç∫
                grid_start_x = 45
                grid_start_y = 180
                cell_width = 101
                cell_height = 100
              %>
              
              <!-- „Ç´„É¨„É≥„ÉÄ„ÉºÊó•‰ªò„Å®„Çπ„Çø„É≥„Éó -->
              <% @calendar_data.each_with_index do |week, week_index| %>
                <% week.each_with_index do |day_data, day_index| %>
                  <% 
                    # 6ÈÄ±ÁõÆ„ÅÆÂêåÊúàÊó•‰ªò„ÅØË°®Á§∫„Çí„Çπ„Ç≠„ÉÉ„Éó
                    next if week_index == 5 && day_data[:current_month]
                  %>
                  <% if day_data[:current_month] %>
                    <% 
                      x_pos = grid_start_x + day_index * cell_width + cell_width / 2
                      y_pos = grid_start_y + week_index * cell_height + cell_height / 2
                      
                      # 6ÈÄ±ÁõÆ„ÅÆÊó•‰ªò„ÇíÊ§úÂá∫„Åó„Å¶ÂâçÈÄ±„ÅÆÂêå„ÅòÊõúÊó•„Å´Ë°®Á§∫„Åô„Çã„É≠„Ç∏„ÉÉ„ÇØ
                      current_date = day_data[:date]
                      is_combined_cell = false
                      combined_dates = []
                      
                      # 5ÈÄ±ÁõÆ„Åß„ÄÅ6ÈÄ±ÁõÆ„Å´Âêå„ÅòÊõúÊó•„ÅÆÂêåÊúàÊó•‰ªò„Åå„ÅÇ„ÇãÂ†¥Âêà
                      if week_index == 4 && day_data[:current_month]
                        # 6ÈÄ±ÁõÆ„ÅÆÂêå„ÅòÊõúÊó•Ôºàday_indexÔºâ„Å´ÂêåÊúà„ÅÆÊó•‰ªò„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                        sixth_week = @calendar_data[5] if @calendar_data.length > 5
                        if sixth_week && sixth_week[day_index] && sixth_week[day_index][:current_month]
                          sixth_week_date = sixth_week[day_index][:date]
                          is_combined_cell = true
                          combined_dates = [current_date.day, sixth_week_date.day]
                        end
                      end
                    %>
                    
                    <!-- Êó•‰ªòË°®Á§∫ -->
                    <% if is_combined_cell && combined_dates.any? %>
                      <!-- Ë§áÊï∞Êó•‰ªò„ÅÆÂ†¥ÂêàÔºàÊñú„ÇÅ„Å´ÈÖçÁΩÆÔºâ -->
                      <!-- 1„Å§ÁõÆ„ÅÆÊó•‰ªòÔºàÂ∑¶‰∏äÔºâ -->
                      <text x="<%= x_pos - 25 %>" 
                            y="<%= y_pos - 18 %>" 
                            text-anchor="middle" 
                            font-family="Arial, sans-serif" 
                            font-size="28" 
                            font-weight="bold" 
                            fill="white">
                        <%= combined_dates[0] %>
                      </text>
                      <!-- „Çπ„É©„ÉÉ„Ç∑„É•Ôºà‰∏≠Â§ÆÔºâ -->
                      <text x="<%= x_pos %>" 
                            y="<%= y_pos %>" 
                            text-anchor="middle" 
                            font-family="Arial, sans-serif" 
                            font-size="24" 
                            font-weight="bold" 
                            fill="white" 
                            opacity="0.8">
                        /
                      </text>
                      <!-- 2„Å§ÁõÆ„ÅÆÊó•‰ªòÔºàÂè≥‰∏ãÔºâ -->
                      <text x="<%= x_pos + 25 %>" 
                            y="<%= y_pos + 18 %>" 
                            text-anchor="middle" 
                            font-family="Arial, sans-serif" 
                            font-size="28" 
                            font-weight="bold" 
                            fill="white">
                        <%= combined_dates[1] %>
                      </text>
                    <% else %>
                      <!-- Âçò‰∏ÄÊó•‰ªò„ÅÆÂ†¥Âêà -->
                      <text x="<%= x_pos %>" 
                            y="<%= y_pos %>" 
                            text-anchor="middle" 
                            font-family="Arial, sans-serif" 
                            font-size="48" 
                            font-weight="bold" 
                            fill="white">
                        <%= day_data[:date].day %>
                      </text>
                    <% end %>
                    
                    <!-- „Çπ„Çø„É≥„ÉóË°®Á§∫ÔºàÊó•‰ªò„ÅÆ‰∏ä„Å´Èáç„Å≠„ÇãÔºâ -->
                    <% if is_combined_cell && combined_dates.any? %>
                      <!-- Ë§áÊï∞Êó•‰ªò„ÅÆ„Çπ„Çø„É≥„ÉóÂá¶ÁêÜ -->
                      <% 
                        # 6ÈÄ±ÁõÆ„ÅÆÊó•‰ªò„ÅÆ„Çπ„Çø„É≥„ÉóÁä∂ÊÖã„ÇíÂèñÂæó
                        date1_stamped = day_data[:stamped]
                        date2_stamped = sixth_week_data[:stamped] if sixth_week_data
                      %>
                      
                      <!-- 1„Å§ÁõÆ„ÅÆÊó•‰ªò„ÅÆ„Çπ„Çø„É≥„Éó -->
                      <% if date1_stamped %>
                        <image href="<%= asset_path('stamp_completed.png') %>" 
                               x="<%= x_pos - 50 %>" 
                               y="<%= y_pos - 63 %>" 
                               width="50" 
                               height="50"
                               opacity="0.8"
                               transform="rotate(-5 <%= x_pos - 25 %> <%= y_pos - 18 %>)"
                               class="stamp-image">
                          <title><%= current_date.strftime("%mÊúà%dÊó•") %>: „Çπ„Çø„É≥„ÉóÊ∏à„Åø</title>
                        </image>
                      <% end %>
                      
                      <!-- 2„Å§ÁõÆ„ÅÆÊó•‰ªò„ÅÆ„Çπ„Çø„É≥„Éó -->
                      <% if date2_stamped %>
                        <image href="<%= asset_path('stamp_completed.png') %>" 
                               x="<%= x_pos %>" 
                               y="<%= y_pos - 27 %>" 
                               width="50" 
                               height="50"
                               opacity="0.8"
                               transform="rotate(-5 <%= x_pos + 25 %> <%= y_pos + 18 %>)"
                               class="stamp-image">
                          <title><%= sixth_week_data[:date].strftime("%mÊúà%dÊó•") %>: „Çπ„Çø„É≥„ÉóÊ∏à„Åø</title>
                        </image>
                      <% end %>
                    <% else %>
                      <!-- Âçò‰∏ÄÊó•‰ªò„ÅÆ„Çπ„Çø„É≥„Éó -->
                      <% if day_data[:stamped] %>
                        <image href="<%= asset_path('stamp_completed.png') %>" 
                               x="<%= x_pos - 40 %>" 
                               y="<%= y_pos - 60 %>" 
                               width="80" 
                               height="80"
                               opacity="0.8"
                               transform="rotate(-5 <%= x_pos %> <%= y_pos %>)"
                               class="stamp-image">
                          <title><%= day_data[:date].strftime("%mÊúà%dÊó•") %>: „Çπ„Çø„É≥„ÉóÊ∏à„ÅøÔºà<%= day_data[:stamped_time] %>Ôºâ</title>
                        </image>
                      <% elsif day_data[:can_stamp] %>
                        <!-- Êäº„Åõ„ÇãÊó•„ÅÆ„Éí„É≥„Éà -->
                        <circle cx="<%= x_pos %>" cy="<%= y_pos %>" 
                                r="40" 
                                fill="none" 
                                stroke="#dc3545"
                                stroke-width="2"
                                stroke-dasharray="5,5"
                                opacity="0.3"
                                class="stamp-hint">
                          <title><%= day_data[:date].strftime("%mÊúà%dÊó•") %>: „Çπ„Çø„É≥„ÉóÂèØËÉΩ</title>
                        </circle>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- ÊúàÈñìÁµ±Ë®à„Çµ„Éû„É™„ÉºÔºàÂè≥ÂÅ¥Ôºâ -->
    <div class="col-lg-5">
      <div class="card" style="height: 1000px !important;">
        <div class="card-header d-flex align-items-center" style="min-height: 4rem;">
          <h5 class="mb-0">üìä ‰ªäÊó•„ÅÆ„Çπ„Çø„É≥„Éó„ÉªË®òÈå≤</h5>
        </div>
        <div class="card-body d-flex flex-column" style="overflow-y: auto; padding-top: 1.5rem;">
          <div class="d-flex flex-column gap-2">
            <!-- ‰ªäÊó•„ÅÆ„Çπ„Çø„É≥„Éó -->
            <% if @monthly_stats[:can_stamp_today] %>
              <div class="text-center p-3 border rounded border-primary bg-primary bg-opacity-10">
                <h6 class="card-title text-primary mb-2">‰ªäÊó•„ÅÆ„É©„Ç∏„Ç™‰ΩìÊìç„ÅØ„ÅÑ„Åã„Åå„Åß„Åó„Åü„ÅãÔºü</h6>
                <p class="card-text mb-3">‰ªäÊó•„ÅÆ„Çπ„Çø„É≥„Éó„ÇíÊäº„Åó„Å¶Ë®òÈå≤„ÇíÊÆã„Åó„Åæ„Åó„Çá„ÅÜÔºÅ</p>
                <%= form_with model: StampCard.new, url: stamp_cards_path, class: "d-inline" do |form| %>
                  <%= form.hidden_field :date, value: Date.current %>
                  <%= form.submit "üìÖ ‰ªäÊó•„ÅÆ„Çπ„Çø„É≥„Éó„ÇíÊäº„Åô", 
                                  class: "btn btn-primary",
                                  "aria-label": "‰ªäÊó•„ÅÆÊó•‰ªòÔºà#{Date.current.strftime('%YÂπ¥%mÊúà%dÊó•')}Ôºâ„Å´„Çπ„Çø„É≥„Éó„ÇíË®òÈå≤",
                                  data: { confirm: "‰ªäÊó•„ÅÆ„Çπ„Çø„É≥„Éó„ÇíÊäº„Åó„Åæ„Åô„ÅãÔºü" } %>
                <% end %>
              </div>
            <% end %>
            
            <!-- Âü∫Êú¨Áµ±Ë®à -->
            <div class="text-center p-3 border rounded bg-light">
              <h6 class="text-primary mb-2">üìÖ ‰ªäÊúà„ÅÆÂèÇÂä†</h6>
              <h3 class="mb-1"><%= @monthly_stats[:total_stamps] %>/<%= @monthly_stats[:days_passed] %>Êó•</h3>
              <div class="text-muted">ÂèÇÂä†Áéá: <%= @monthly_stats[:participation_rate] %>%</div>
            </div>
            
            <div class="text-center p-3 border rounded bg-light">
              <h6 class="text-success mb-2">‚≠ê Á∑èÂèÇÂä†Êó•Êï∞</h6>
              <h3 class="mb-0"><%= @user_stats[:total_stamps] %>Êó•</h3>
            </div>
            
            <div class="text-center p-3 border rounded bg-light">
              <h6 class="text-warning mb-2">üî• ÈÄ£Á∂öÊó•Êï∞</h6>
              <h3 class="mb-0"><%= @user_stats[:consecutive_days] %>Êó•</h3>
            </div>
            
            <div class="text-center p-3 border rounded bg-light">
              <h6 class="text-info mb-2">üèÜ ÊúÄÈï∑Ë®òÈå≤</h6>
              <h3 class="mb-0"><%= @user_stats[:longest_streak] %>Êó•</h3>
            </div>
            
            <!-- Ë©≥Á¥∞Áµ±Ë®à -->
            <div class="border rounded p-3 bg-light">
              <h6 class="text-secondary mb-3">üìà Ë©≥Á¥∞„Éá„Éº„Çø</h6>
              <div class="row g-2 text-center">
                <div class="col-6">
                  <small class="text-muted d-block mb-1">‰ªäÂπ¥„ÅÆÂèÇÂä†</small>
                  <h5 class="mb-0"><%= @user_stats[:stamps_this_year] %>Êó•</h5>
                </div>
                <% if @user_stats[:average_time] %>
                <div class="col-6">
                  <small class="text-muted d-block mb-1">Âπ≥ÂùáÊôÇÂàª</small>
                  <h5 class="mb-0"><%= @user_stats[:average_time] %></h5>
                </div>
                <% end %>
              </div>
            </div>
            
            <!-- ÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏ -->
            <div class="border rounded p-3 bg-gradient" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
              <h6 class="text-secondary mb-2">üí™ ÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏</h6>
              <% if @user_stats[:consecutive_days] >= 30 %>
                <p class="text-success mb-0">
                  <strong>Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ</strong><br>
                  <small><%= @user_stats[:consecutive_days] %>Êó•ÈÄ£Á∂öÂèÇÂä†„ÅØÊú¨ÂΩì„Å´Á´ãÊ¥æ„Åß„ÅôÔºÅ</small>
                </p>
              <% elsif @user_stats[:consecutive_days] >= 7 %>
                <p class="text-primary mb-0">
                  <strong>„ÅäÁñ≤„ÇåÊßòÔºÅ</strong><br>
                  <small><%= @user_stats[:consecutive_days] %>Êó•ÈÄ£Á∂öÂèÇÂä†‰∏≠„Åß„Åô„ÄÇ„Åì„ÅÆË™øÂ≠ê„ÅßÔºÅ</small>
                </p>
              <% elsif @user_stats[:consecutive_days] > 0 %>
                <p class="text-info mb-0">
                  <strong>„ÅÑ„ÅÑ„Éö„Éº„Çπ„Åß„ÅôÔºÅ</strong><br>
                  <small><%= @user_stats[:consecutive_days] %>Êó•ÈÄ£Á∂öÂèÇÂä†‰∏≠„ÄÇÁøíÊÖ£Âåñ„Åæ„Åß„ÅÇ„Å®Â∞ë„ÅóÔºÅ</small>
                </p>
              <% else %>
                <p class="text-muted mb-0">
                  <strong>‰ªäÊó•„Åã„ÇâÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ</strong><br>
                  <small>„É©„Ç∏„Ç™‰ΩìÊìç„ÅßÂÅ•Â∫∑ÁöÑ„Å™ÊØéÊó•„Çí„Çπ„Çø„Éº„ÉàÔºÅ</small>
                </p>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

