<% content_for :title, "スタンプカード" %>

<div class="container-fluid mt-4">
  <!-- スタンプ押印ボタン -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center">
          <% if @stamped_today %>
            <h4 class="text-success">✅ 今日のスタンプは押印済みです！</h4>
            <p class="text-muted">明日もがんばりましょう！</p>
          <% else %>
            <h4>🌅 今日のラジオ体操はお疲れ様でした！</h4>
            <p class="mb-3">スタンプを押して記録しましょう</p>
            <%= form_with url: stamp_cards_path, method: :post, local: true do |f| %>
              <%= f.submit "✋ スタンプを押す", class: "btn btn-primary btn-lg" %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- 励ましメッセージ -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="alert alert-info">
        <strong>💪 <%= encouragement_message(@consecutive_days) %></strong>
      </div>
    </div>
  </div>

  <!-- スタンプカード画像表示 + 統計情報 -->
  <div class="row">
    <!-- スタンプカード部分 -->
    <div class="col-lg-8 col-md-7 mb-4">
      <div class="card">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
          <h6 class="mb-0 text-muted">📅 <%= format_month_display(@current_month) %> のスタンプ記録</h6>
          <!-- 月間ナビゲーション -->
          <div class="month-navigation">
            <%= month_navigation_link(@previous_month, :previous) %>
            <span class="mx-2">|</span>
            <%= month_navigation_link(@next_month, :next) %>
          </div>
        </div>
        <div class="card-body py-3">
          <div class="stamp-card-container">
            <!-- 背景のスタンプカード画像 -->
            <div class="stamp-card-background">
              <%= image_tag "cards/stamp_card.png", class: "stamp-card-image", alt: "ラジオ体操カード" %>
            </div>
            
            <!-- 月・年・ユーザー名オーバーレイ -->
            <div class="month-year-overlay">
              <div class="calendar-year"><%= format_year_display(@current_month) %></div>
              <div class="calendar-month-number"><%= format_month_number(@current_month) %></div>
              <div class="calendar-month-text">月</div>
              <div class="calendar-user-name"><%= current_user.email.split('@').first %></div>
            </div>
            
            <!-- 日付・スタンプオーバーレイ -->
            <div class="stamp-overlay">
              <% @calendar_days.each_with_index do |week, week_index| %>
                <% week.each_with_index do |day, day_index| %>
                  <div class="stamp-position <%= calendar_day_classes(day) %>" 
                       data-week="<%= week_index %>" 
                       data-day="<%= day_index %>"
                       data-date="<%= day[:date].day %>">
                    
                    <!-- 常に日付数字を表示 -->
                    <div class="date-number">
                      <%= format_day_number(day[:date]) %>
                    </div>
                    
                    <% if day[:stamped] %>
                      <!-- スタンプ済みの日にはスタンプ画像をオーバーレイ -->
                      <div class="stamp-overlay-image">
                        <div class="participation-stamp">斉</div>
                      </div>
                    <% end %>
                    
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 統計情報部分 -->
    <div class="col-lg-4 col-md-5 mb-4">
      <div class="statistics-sidebar" style="display: flex; flex-direction: column; gap: 30px; height: 100%;">
        <!-- 連続日数 -->
        <div class="card text-center" style="flex: 1; min-height: 150px;">
          <div class="card-body" style="padding: 2rem; display: flex; flex-direction: column; justify-content: center;">
            <h5 class="card-title" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">🔥 連続日数</h5>
            <h2 class="text-warning" style="font-size: 3rem; font-weight: bold; margin: 0;"><%= @consecutive_days %> 日</h2>
          </div>
        </div>
        
        <!-- 総スタンプ数 -->
        <div class="card text-center" style="flex: 1; min-height: 150px;">
          <div class="card-body" style="padding: 2rem; display: flex; flex-direction: column; justify-content: center;">
            <h5 class="card-title" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">⭐ 総スタンプ数</h5>
            <h2 class="text-success" style="font-size: 3rem; font-weight: bold; margin: 0;"><%= @total_stamps %> 個</h2>
          </div>
        </div>
        
        <!-- 今月の参加率 -->
        <div class="card text-center" style="flex: 1; min-height: 150px;">
          <div class="card-body" style="padding: 2rem; display: flex; flex-direction: column; justify-content: center;">
            <h5 class="card-title" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">📊 今月の参加率</h5>
            <h2 class="<%= participation_rate_color_class(@monthly_participation_rate) %>" style="font-size: 3rem; font-weight: bold; margin: 0;"><%= @monthly_participation_rate %>%</h2>
            <small class="text-muted">(<%= @monthly_stamps %>日参加)</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 最近のスタンプ記録 -->
  <% if @stamp_cards.any? %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">📋 最近のスタンプ記録</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>日付</th>
                    <th>スタンプ時刻</th>
                    <th>曜日</th>
                  </tr>
                </thead>
                <tbody>
                  <% @stamp_cards.limit(10).each do |stamp| %>
                    <tr>
                      <td><%= stamp.date.strftime("%Y年%m月%d日") %></td>
                      <td><%= stamp.stamped_at.strftime("%H:%M") %></td>
                      <td><%= %w[日 月 火 水 木 金 土][stamp.date.wday] %>曜日</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<style>
/* スタンプカード画像オーバーレイ専用の日付中央配置 */
.stamp-card-container {
  position: relative;
  display: inline-block;
  width: 100%;
}

.stamp-card-background {
  position: relative;
  width: 100%;
}

.stamp-card-image {
  width: 100%;
  height: auto;
  display: block;
}

/* CSS Gridを無効化 - application.scssの座標指定を優先 */
.stamp-overlay {
  /* application.scssで定義済みのため無効化 */
}

/* stamp-positionもapplication.scssで定義済みのため無効化 */
.stamp-position {
  /* application.scssで詳細に定義済み */
}

.stamp-position .date-number {
  position: relative !important;
  z-index: 100 !important;
  font-weight: bold !important;
  font-size: 1.2rem !important;
  color: white !important;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.7) !important;
  pointer-events: none;
}

/* スタンプ画像は日付位置に影響させない */
.stamp-position .stamp-overlay-image {
  position: absolute !important;
  top: 50% !important;
  left: 50% !important;
  transform: translate(-50%, 15px) !important;
  z-index: 50 !important;
}

.stamp-position .participation-stamp {
  background: rgba(255, 215, 0, 0.9);
  color: #d4691b;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 0.8rem;
  border: 2px solid #d4691b;
}

.card {
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  border: 1px solid rgba(0, 0, 0, 0.125);
}

.today-marker {
  position: relative;
  z-index: 2;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
  .stamp-overlay {
    top: 17%;
    left: 3%;
    width: 94%;
    height: 72%;
  }
  
  .stamp-position .date-number {
    font-size: 1rem !important;
  }
  
  .stamp-position .participation-stamp {
    width: 16px;
    height: 16px;
    font-size: 0.7rem;
  }
}

@media (max-width: 576px) {
  .stamp-overlay {
    top: 15%;
    left: 2%;
    width: 96%;
    height: 74%;
  }
  
  .stamp-position .date-number {
    font-size: 0.9rem !important;
  }
  
  .stamp-position .participation-stamp {
    width: 14px;
    height: 14px;
    font-size: 0.6rem;
  }
}
</style>