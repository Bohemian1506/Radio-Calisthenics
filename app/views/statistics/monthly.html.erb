<div class="container-fluid py-4">
  <div class="row">
    <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="h3 mb-2">ğŸ“… <%= @month.strftime('%Yå¹´%mæœˆ') %> ã®è©³ç´°çµ±è¨ˆ</h1>
              <p class="text-muted mb-0">æœˆæ¬¡ã®å‚åŠ çŠ¶æ³ã‚’è©³ã—ãåˆ†æ</p>
            </div>
            <div>
              <%= link_to statistics_path, class: "btn btn-outline-primary" do %>
                â† çµ±è¨ˆãƒˆãƒƒãƒ—ã«æˆ»ã‚‹
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æœˆæ¬¡ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-center align-items-center gap-3">
            <% prev_month = @month - 1.month %>
            <%= link_to monthly_statistics_path(year: prev_month.year, month: prev_month.month), 
                        class: "btn btn-outline-secondary" do %>
              â† <%= prev_month.strftime('%Yå¹´%mæœˆ') %>
            <% end %>
            
            <h5 class="mb-0 mx-3"><%= @month.strftime('%Yå¹´%mæœˆ') %></h5>
            
            <% next_month = @month + 1.month %>
            <% if next_month <= Date.current.end_of_month %>
              <%= link_to monthly_statistics_path(year: next_month.year, month: next_month.month), 
                          class: "btn btn-outline-secondary" do %>
                <%= next_month.strftime('%Yå¹´%mæœˆ') %> â†’
              <% end %>
            <% else %>
              <button class="btn btn-outline-secondary" disabled>
                <%= next_month.strftime('%Yå¹´%mæœˆ') %> â†’
              </button>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- æœˆæ¬¡çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-primary mb-3">
            <span class="fs-1">ğŸ“Š</span>
          </div>
          <h5 class="card-title">å‚åŠ æ•°</h5>
          <h2 class="text-primary mb-0"><%= @monthly_stats[:total_stamps] %></h2>
          <small class="text-muted">/ <%= @monthly_stats[:days_in_month] %> æ—¥</small>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-success mb-3">
            <span class="fs-1">ğŸ“ˆ</span>
          </div>
          <h5 class="card-title">å‚åŠ ç‡</h5>
          <h2 class="text-success mb-0"><%= @monthly_stats[:participation_rate].round(1) %>%</h2>
          <small class="text-muted">æœˆé–“å‚åŠ ç‡</small>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-info mb-3">
            <span class="fs-1">â°</span>
          </div>
          <h5 class="card-title">å¹³å‡å‚åŠ æ™‚åˆ»</h5>
          <h2 class="text-info mb-0">
            <% if @monthly_stats[:average_time] %>
              <%= Time.new(2000, 1, 1, 0, @monthly_stats[:average_time].to_i).strftime("%H:%M") %>
            <% else %>
              ---
            <% end %>
          </h2>
          <small class="text-muted">å¹³å‡æ™‚åˆ»</small>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-warning mb-3">
            <span class="fs-1">â±ï¸</span>
          </div>
          <h5 class="card-title">å‚åŠ æ™‚é–“å¸¯</h5>
          <div class="small">
            <div><strong>æœ€æ—©:</strong> <%= @monthly_stats[:earliest_time] || "---" %></div>
            <div><strong>æœ€é…:</strong> <%= @monthly_stats[:latest_time] || "---" %></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">ğŸ“… <%= @month.strftime('%Yå¹´%mæœˆ') %> ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h5>
        </div>
        <div class="card-body">
          <div class="calendar-grid">
            <!-- æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="row text-center fw-bold border-bottom pb-2 mb-3">
              <div class="col text-danger">æ—¥</div>
              <div class="col">æœˆ</div>
              <div class="col">ç«</div>
              <div class="col">æ°´</div>
              <div class="col">æœ¨</div>
              <div class="col">é‡‘</div>
              <div class="col text-primary">åœŸ</div>
            </div>
            
            <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ—¥ä»˜ -->
            <% @calendar_data.each do |week| %>
              <div class="row text-center mb-2">
                <% week.each do |day| %>
                  <div class="col">
                    <div class="calendar-day p-2 rounded <%= 
                      day[:today] ? 'bg-warning' : 
                      day[:stamped] ? 'bg-success text-white stamped' : 
                      day[:current_month] ? 'bg-light unstamped' : 'bg-transparent text-muted'
                    %>" style="min-height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;">
                      <div class="day-number" style="font-weight: bold; font-size: 1.2rem; margin-bottom: 5px;"><%= day[:date].day %></div>
                      <% if day[:stamped] && day[:current_month] %>
                        <%= image_tag "stamps/heart_stamp.svg", class: "stamp-image", alt: "å‚åŠ æ¸ˆã¿", style: "width: 30px; height: 30px; margin: 2px auto; display: block;" %>
                        <div class="stamp-time small" style="position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); white-space: nowrap; font-size: 0.7rem;">
                          <%= day[:stamped_time] %>
                        </div>
                      <% elsif day[:current_month] %>
                        <%= image_tag "stamps/empty_stamp.svg", class: "empty-stamp-image", alt: "æœªå‚åŠ ", style: "width: 30px; height: 30px; margin: 2px auto; display: block;" %>
                      <% end %>
                      <% if day[:today] %>
                        <div class="today-marker small">Today</div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
          
          <div class="row mt-4">
            <div class="col-12">
              <div class="d-flex justify-content-center gap-4 small">
                <div>
                  <span class="badge bg-success">
                    <%= image_tag "stamps/heart_stamp.svg", style: "width: 16px; height: 16px;", alt: "å‚åŠ æ¸ˆã¿" %>
                  </span> 
                  å‚åŠ æ¸ˆã¿
                </div>
                <div><span class="badge bg-warning">Today</span> ä»Šæ—¥</div>
                <div>
                  <span class="badge bg-light text-dark">
                    <%= image_tag "stamps/empty_stamp.svg", style: "width: 14px; height: 14px; opacity: 0.6;", alt: "æœªå‚åŠ " %>
                  </span> 
                  æœªå‚åŠ 
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- é€±åˆ¥çµ±è¨ˆ -->
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">ğŸ“Š é€±åˆ¥å‚åŠ çŠ¶æ³</h5>
        </div>
        <div class="card-body">
          <canvas id="weeklyChart" width="400" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- é€±åˆ¥è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">ğŸ“‹ é€±åˆ¥è©³ç´°ãƒ‡ãƒ¼ã‚¿</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>é€±</th>
                  <th>æœŸé–“</th>
                  <th>å‚åŠ æ•°</th>
                  <th>å‚åŠ ç‡</th>
                  <th>çŠ¶æ³</th>
                </tr>
              </thead>
              <tbody>
                <% @monthly_stats[:stamps_by_week].each_with_index do |week, index| %>
                  <tr>
                    <td><strong>ç¬¬<%= index + 1 %>é€±</strong></td>
                    <td>
                      <%= week[:start_date].strftime('%m/%d') %> - 
                      <%= week[:end_date].strftime('%m/%d') %>
                    </td>
                    <td>
                      <span class="badge bg-primary"><%= week[:stamp_count] %></span>
                    </td>
                    <td>
                      <% week_days = (week[:start_date]..week[:end_date]).select { |d| d.month == @month.month }.count %>
                      <% week_rate = week_days > 0 ? (week[:stamp_count].to_f / week_days * 100).round(1) : 0 %>
                      <span class="badge <%= week_rate >= 80 ? 'bg-success' : week_rate >= 50 ? 'bg-warning' : 'bg-secondary' %>">
                        <%= week_rate %>%
                      </span>
                    </td>
                    <td>
                      <% if week_rate >= 80 %>
                        <span class="text-success">ğŸŒŸ ç´ æ™´ã‚‰ã—ã„</span>
                      <% elsif week_rate >= 50 %>
                        <span class="text-warning">ğŸ‘ è‰¯ã„</span>
                      <% else %>
                        <span class="text-muted">ğŸ’ª ãŒã‚“ã°ã‚ã†</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.jsçµ±åˆ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// é€±åˆ¥çµ±è¨ˆã‚°ãƒ©ãƒ•
const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
const weeklyChart = new Chart(weeklyCtx, {
    type: 'bar',
    data: {
        labels: [<%= @monthly_stats[:stamps_by_week].map.with_index { |week, i| "'ç¬¬#{i+1}é€±'" }.join(', ') %>],
        datasets: [{
            label: 'å‚åŠ æ•°',
            data: [<%= @monthly_stats[:stamps_by_week].map { |week| week[:stamp_count] }.join(', ') %>],
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: '<%= @month.strftime('%Yå¹´%mæœˆ') %> é€±åˆ¥å‚åŠ çŠ¶æ³'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 7,
                title: {
                    display: true,
                    text: 'å‚åŠ æ•°'
                }
            }
        }
    }
});
</script>

<style>
/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰å…¨ä½“ */
.calendar-grid .row .col .calendar-day {
    min-height: 80px !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    position: relative !important;
    padding: 5px !important;
}

/* æ—¥ä»˜æ•°å­—ã®ã‚¹ã‚¿ã‚¤ãƒ«å¼·åŒ– */
.calendar-grid .calendar-day .day-number {
    font-weight: bold !important;
    font-size: 1.2rem !important;
    margin-bottom: 5px !important;
    display: block !important;
    text-align: center !important;
}

/* ã‚¹ã‚¿ãƒ³ãƒ—ç”»åƒ */
.calendar-grid .calendar-day .stamp-image, 
.calendar-grid .calendar-day .empty-stamp-image {
    width: 30px !important;
    height: 30px !important;
    margin: 2px auto !important;
    display: block !important;
}

/* ã‚¹ã‚¿ãƒ³ãƒ—æ™‚åˆ» */
.calendar-grid .calendar-day .stamp-time {
    position: absolute !important;
    bottom: 2px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    white-space: nowrap !important;
    font-size: 0.7rem !important;
}

/* ä»Šæ—¥ãƒãƒ¼ã‚«ãƒ¼ */
.calendar-grid .calendar-day .today-marker {
    position: absolute !important;
    top: 2px !important;
    right: 2px !important;
    font-size: 0.7em !important;
}

/* ã‚°ãƒªãƒƒãƒ‰ã®ã‚³ãƒ©ãƒ å¹…ã‚’å‡ç­‰ã« */
.calendar-grid .row {
    --bs-gutter-x: 0.5rem !important;
}

.calendar-grid .col {
    flex: 1 0 0% !important;
    max-width: 14.28% !important;
    padding: 0.25rem !important;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
    .calendar-grid .row .col .calendar-day {
        min-height: 60px !important;
        padding: 3px !important;
    }
    
    .calendar-grid .calendar-day .day-number {
        font-size: 1rem !important;
        margin-bottom: 3px !important;
    }
    
    .calendar-grid .calendar-day .stamp-image, 
    .calendar-grid .calendar-day .empty-stamp-image {
        width: 24px !important;
        height: 24px !important;
    }
    
    .calendar-grid .calendar-day .stamp-time {
        font-size: 0.6rem !important;
    }
}
</style>