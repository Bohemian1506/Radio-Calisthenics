<div class="container-fluid py-4">
  <div class="row">
    <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="h3 mb-2">ğŸ“… <%= @month.strftime('%Yå¹´%mæœˆ') %> ã®è©³ç´°çµ±è¨ˆ</h1>
              <p class="text-muted mb-0">æœˆæ¬¡ã®å‚åŠ çŠ¶æ³ã‚’è©³ã—ãåˆ†æ</p>
            </div>
            <div>
              <%= link_to statistics_path, class: "btn btn-outline-primary" do %>
                â† çµ±è¨ˆãƒˆãƒƒãƒ—ã«æˆ»ã‚‹
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æœˆæ¬¡ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-center align-items-center gap-3">
            <% prev_month = @month - 1.month %>
            <%= link_to monthly_statistics_path(year: prev_month.year, month: prev_month.month), 
                        class: "btn btn-outline-secondary" do %>
              â† <%= prev_month.strftime('%Yå¹´%mæœˆ') %>
            <% end %>
            
            <h5 class="mb-0 mx-3"><%= @month.strftime('%Yå¹´%mæœˆ') %></h5>
            
            <% next_month = @month + 1.month %>
            <% if next_month <= Date.current.end_of_month %>
              <%= link_to monthly_statistics_path(year: next_month.year, month: next_month.month), 
                          class: "btn btn-outline-secondary" do %>
                <%= next_month.strftime('%Yå¹´%mæœˆ') %> â†’
              <% end %>
            <% else %>
              <button class="btn btn-outline-secondary" disabled>
                <%= next_month.strftime('%Yå¹´%mæœˆ') %> â†’
              </button>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- æœˆæ¬¡çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-primary mb-3">
            <span class="fs-1">ğŸ“Š</span>
          </div>
          <h5 class="card-title">å‚åŠ æ•°</h5>
          <h2 class="text-primary mb-0"><%= @monthly_stats[:total_stamps] %></h2>
          <small class="text-muted">/ <%= @monthly_stats[:days_in_month] %> æ—¥</small>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-success mb-3">
            <span class="fs-1">ğŸ“ˆ</span>
          </div>
          <h5 class="card-title">å‚åŠ ç‡</h5>
          <h2 class="text-success mb-0"><%= @monthly_stats[:participation_rate].round(1) %>%</h2>
          <small class="text-muted">æœˆé–“å‚åŠ ç‡</small>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-info mb-3">
            <span class="fs-1">â°</span>
          </div>
          <h5 class="card-title">å¹³å‡å‚åŠ æ™‚åˆ»</h5>
          <h2 class="text-info mb-0">
            <% if @monthly_stats[:average_time].present? && @monthly_stats[:average_time].is_a?(Numeric) %>
              <% 
                total_minutes = @monthly_stats[:average_time].to_i
                hours = total_minutes / 60
                minutes = total_minutes % 60
                # æœ‰åŠ¹ãªæ™‚é–“ç¯„å›²å†…ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                if hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59
              %>
                <%= sprintf("%02d:%02d", hours, minutes) %>
              <% else %>
                ---
              <% end %>
            <% else %>
              ---
            <% end %>
          </h2>
          <small class="text-muted">å¹³å‡æ™‚åˆ»</small>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-warning mb-3">
            <span class="fs-1">â±ï¸</span>
          </div>
          <h5 class="card-title">å‚åŠ æ™‚é–“å¸¯</h5>
          <div class="small">
            <div><strong>æœ€æ—©:</strong> <%= @monthly_stats[:earliest_time] || "---" %></div>
            <div><strong>æœ€é…:</strong> <%= @monthly_stats[:latest_time] || "---" %></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">ğŸ“… <%= @month.strftime('%Yå¹´%mæœˆ') %> ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h5>
        </div>
        <div class="card-body">
          <div class="calendar-grid">
            <!-- æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="row text-center fw-bold border-bottom pb-2 mb-3">
              <div class="col text-danger">æ—¥</div>
              <div class="col">æœˆ</div>
              <div class="col">ç«</div>
              <div class="col">æ°´</div>
              <div class="col">æœ¨</div>
              <div class="col">é‡‘</div>
              <div class="col text-primary">åœŸ</div>
            </div>
            
            <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ—¥ä»˜ -->
            <% @calendar_data.each do |week| %>
              <div class="row text-center mb-2">
                <% week.each do |day| %>
                  <div class="col">
                    <div class="calendar-day rounded-3 border <%= 
                      day[:today] ? 'border-warning border-3' : 
                      day[:stamped] ? 'bg-primary text-white stamped' : 
                      day[:current_month] ? 'bg-primary bg-opacity-75 text-white' : 'bg-light text-muted'
                    %>" style="min-height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: pointer;">
                      <% if day[:current_month] %>
                        <div class="day-number" style="font-weight: bold; font-size: 1.5rem; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);"><%= day[:date].day %></div>
                        <% if day[:stamped] %>
                          <%= image_tag "heart_stamp.svg", class: "stamp-image", alt: "å‚åŠ æ¸ˆã¿", style: "width: 25px; height: 25px; margin-top: -5px; opacity: 0.9;" %>
                          <div class="stamp-time" style="position: absolute; bottom: 2px; font-size: 0.6rem; color: white; opacity: 0.8;">
                            <%= day[:stamped_time] %>
                          </div>
                        <% end %>
                      <% else %>
                        <div class="day-number" style="font-size: 1.2rem; color: #999;"><%= day[:date].day %></div>
                      <% end %>
                      <% if day[:today] %>
                        <div class="today-indicator" style="position: absolute; top: 2px; right: 2px; background: #ffc107; color: #000; padding: 1px 4px; border-radius: 3px; font-size: 0.6rem; font-weight: bold;">TODAY</div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
          
          <div class="row mt-4">
            <div class="col-12">
              <div class="d-flex justify-content-center gap-4 small">
                <div>
                  <span class="badge bg-success">
                    <%= image_tag "heart_stamp.svg", style: "width: 16px; height: 16px;", alt: "å‚åŠ æ¸ˆã¿" %>
                  </span> 
                  å‚åŠ æ¸ˆã¿
                </div>
                <div><span class="badge bg-warning">Today</span> ä»Šæ—¥</div>
                <div>
                  <span class="badge bg-light text-dark">
                    <%= image_tag "stamps/empty_stamp.svg", style: "width: 14px; height: 14px; opacity: 0.6;", alt: "æœªå‚åŠ " %>
                  </span> 
                  æœªå‚åŠ 
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- é€±åˆ¥çµ±è¨ˆ -->
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">ğŸ“Š é€±åˆ¥å‚åŠ çŠ¶æ³</h5>
        </div>
        <div class="card-body">
          <canvas id="weeklyChart" width="400" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- é€±åˆ¥è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">ğŸ“‹ é€±åˆ¥è©³ç´°ãƒ‡ãƒ¼ã‚¿</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>é€±</th>
                  <th>æœŸé–“</th>
                  <th>å‚åŠ æ•°</th>
                  <th>å‚åŠ ç‡</th>
                  <th>çŠ¶æ³</th>
                </tr>
              </thead>
              <tbody>
                <% @monthly_stats[:stamps_by_week].each_with_index do |week, index| %>
                  <tr>
                    <td><strong>ç¬¬<%= index + 1 %>é€±</strong></td>
                    <td>
                      <%= week[:start_date].strftime('%m/%d') %> - 
                      <%= week[:end_date].strftime('%m/%d') %>
                    </td>
                    <td>
                      <span class="badge bg-primary"><%= week[:stamp_count] %></span>
                    </td>
                    <td>
                      <% week_days = (week[:start_date]..week[:end_date]).select { |d| d.month == @month.month }.count %>
                      <% week_rate = week_days > 0 ? (week[:stamp_count].to_f / week_days * 100).round(1) : 0 %>
                      <span class="badge <%= week_rate >= 80 ? 'bg-success' : week_rate >= 50 ? 'bg-warning' : 'bg-secondary' %>">
                        <%= week_rate %>%
                      </span>
                    </td>
                    <td>
                      <% if week_rate >= 80 %>
                        <span class="text-success">ğŸŒŸ ç´ æ™´ã‚‰ã—ã„</span>
                      <% elsif week_rate >= 50 %>
                        <span class="text-warning">ğŸ‘ è‰¯ã„</span>
                      <% else %>
                        <span class="text-muted">ğŸ’ª ãŒã‚“ã°ã‚ã†</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.jsçµ±åˆ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// é€±åˆ¥çµ±è¨ˆã‚°ãƒ©ãƒ•
const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
const weeklyChart = new Chart(weeklyCtx, {
    type: 'bar',
    data: {
        labels: [<%= @monthly_stats[:stamps_by_week].map.with_index { |week, i| "'ç¬¬#{i+1}é€±'" }.join(', ') %>],
        datasets: [{
            label: 'å‚åŠ æ•°',
            data: [<%= @monthly_stats[:stamps_by_week].map { |week| week[:stamp_count] }.join(', ') %>],
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: '<%= @month.strftime('%Yå¹´%mæœˆ') %> é€±åˆ¥å‚åŠ çŠ¶æ³'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 7,
                title: {
                    display: true,
                    text: 'å‚åŠ æ•°'
                }
            }
        }
    }
});
</script>

<style>
/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰å…¨ä½“ */
.calendar-grid {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
}

.calendar-grid .row {
    --bs-gutter-x: 0.5rem !important;
}

.calendar-grid .col {
    flex: 1 0 0% !important;
    max-width: 14.28% !important;
    padding: 0.25rem !important;
}

/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚»ãƒ« */
.calendar-grid .calendar-day {
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.calendar-grid .calendar-day:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

/* æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.calendar-grid .row.border-bottom {
    background-color: #e9ecef;
    margin: -15px -15px 10px -15px;
    padding: 10px 15px;
    border-radius: 10px 10px 0 0;
}

/* ä»Šæ—¥ã®å¼·èª¿è¡¨ç¤º */
.calendar-day.border-warning {
    animation: pulse-border 2s ease-in-out infinite;
}

@keyframes pulse-border {
    0% { border-color: #ffc107; }
    50% { border-color: #ff9800; }
    100% { border-color: #ffc107; }
}

/* ã‚¹ã‚¿ãƒ³ãƒ—ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè‡ªå‹•å®Ÿè¡Œã‚’å‰Šé™¤ã€JavaScriptã‹ã‚‰æ‰‹å‹•ã§ãƒˆãƒªã‚¬ãƒ¼ï¼‰ */
.stamp-image {
    // animation: stamp-appear 0.3s ease-out;
    
    // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—ã®ã¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    &.new-stamp {
        animation: stamp-appear 0.3s ease-out;
    }
}

@keyframes stamp-appear {
    0% { transform: scale(0) rotate(-180deg); opacity: 0; }
    50% { transform: scale(1.2) rotate(-90deg); opacity: 0.8; }
    100% { transform: scale(1) rotate(0deg); opacity: 0.9; }
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
    .calendar-grid .row .col .calendar-day {
        min-height: 60px !important;
        padding: 3px !important;
    }
    
    .calendar-grid .calendar-day .day-number {
        font-size: 1rem !important;
        margin-bottom: 3px !important;
    }
    
    .calendar-grid .calendar-day .stamp-image, 
    .calendar-grid .calendar-day .empty-stamp-image {
        width: 24px !important;
        height: 24px !important;
    }
    
    .calendar-grid .calendar-day .stamp-time {
        font-size: 0.6rem !important;
    }
}
</style>