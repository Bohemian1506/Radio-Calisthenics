<div class="container-fluid py-4">
  <div class="row">
    <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="h3 mb-2">ğŸ“Š <%= @year %>å¹´ã®è©³ç´°çµ±è¨ˆ</h1>
              <p class="text-muted mb-0">å¹´é–“ã®å‚åŠ çŠ¶æ³ã‚’è©³ã—ãåˆ†æ</p>
            </div>
            <div>
              <%= link_to statistics_path, class: "btn btn-outline-primary" do %>
                â† çµ±è¨ˆãƒˆãƒƒãƒ—ã«æˆ»ã‚‹
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å¹´æ¬¡ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-center align-items-center gap-3">
            <% if @year > current_user.created_at.year %>
              <%= link_to yearly_statistics_path(year: @year - 1), 
                          class: "btn btn-outline-secondary" do %>
                â† <%= @year - 1 %>å¹´
              <% end %>
            <% else %>
              <button class="btn btn-outline-secondary" disabled>
                â† <%= @year - 1 %>å¹´
              </button>
            <% end %>
            
            <h5 class="mb-0 mx-3"><%= @year %>å¹´</h5>
            
            <% if @year < Date.current.year %>
              <%= link_to yearly_statistics_path(year: @year + 1), 
                          class: "btn btn-outline-secondary" do %>
                <%= @year + 1 %>å¹´ â†’
              <% end %>
            <% else %>
              <button class="btn btn-outline-secondary" disabled>
                <%= @year + 1 %>å¹´ â†’
              </button>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- å¹´æ¬¡çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-primary mb-3">
            <span class="fs-1">ğŸ¯</span>
          </div>
          <h5 class="card-title">å¹´é–“å‚åŠ æ•°</h5>
          <h2 class="text-primary mb-0"><%= @yearly_stats[:total_stamps] %></h2>
          <small class="text-muted">/ <%= @yearly_stats[:days_in_year] %> æ—¥</small>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-success mb-3">
            <span class="fs-1">ğŸ“ˆ</span>
          </div>
          <h5 class="card-title">å¹´é–“å‚åŠ ç‡</h5>
          <h2 class="text-success mb-0"><%= @yearly_stats[:participation_rate].round(1) %>%</h2>
          <small class="text-muted">å¹´é–“å‚åŠ ç‡</small>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-warning mb-3">
            <span class="fs-1">ğŸ”¥</span>
          </div>
          <h5 class="card-title">å¹´é–“æœ€é•·é€£ç¶š</h5>
          <h2 class="text-warning mb-0"><%= @yearly_stats[:longest_streak_in_year] %></h2>
          <small class="text-muted">æ—¥é€£ç¶š</small>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-info mb-3">
            <span class="fs-1">â­</span>
          </div>
          <h5 class="card-title">æœ€ã‚‚æ´»ç™ºãªæœˆ</h5>
          <h4 class="text-info mb-0"><%= @yearly_stats[:most_active_month] || "---" %></h4>
          <small class="text-muted">æœ€é«˜è¨˜éŒ²æœˆ</small>
        </div>
      </div>
    </div>
  </div>

  <!-- å¹´é–“æ¨ç§»ã‚°ãƒ©ãƒ• -->
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">ğŸ“Š <%= @year %>å¹´ æœˆåˆ¥å‚åŠ æ¨ç§»</h5>
        </div>
        <div class="card-body">
          <canvas id="monthlyProgressChart" width="400" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- æœˆåˆ¥å‚åŠ ç‡ã‚°ãƒ©ãƒ• -->
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">ğŸ“ˆ <%= @year %>å¹´ æœˆåˆ¥å‚åŠ ç‡</h5>
        </div>
        <div class="card-body">
          <canvas id="monthlyRateChart" width="400" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- æœˆåˆ¥è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">ğŸ“‹ <%= @year %>å¹´ æœˆåˆ¥è©³ç´°ãƒ‡ãƒ¼ã‚¿</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>æœˆ</th>
                  <th>å‚åŠ æ•°</th>
                  <th>æœˆé–“æ—¥æ•°</th>
                  <th>å‚åŠ ç‡</th>
                  <th>è©•ä¾¡</th>
                  <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                </tr>
              </thead>
              <tbody>
                <% @yearly_stats[:monthly_breakdown].each do |month_data| %>
                  <tr>
                    <td>
                      <strong><%= month_data[:month] %>æœˆ</strong>
                      <br>
                      <small class="text-muted"><%= month_data[:month_name] %></small>
                    </td>
                    <td>
                      <span class="badge bg-primary fs-6">
                        <%= month_data[:stamp_count] %>
                      </span>
                    </td>
                    <td>
                      <%= month_data[:days_in_month] %>æ—¥
                    </td>
                    <td>
                      <% rate = month_data[:participation_rate] %>
                      <span class="badge <%= 
                        rate >= 80 ? 'bg-success' : 
                        rate >= 60 ? 'bg-warning' : 
                        rate >= 40 ? 'bg-info' : 'bg-secondary' 
                      %> fs-6">
                        <%= rate.round(1) %>%
                      </span>
                    </td>
                    <td>
                      <% if rate >= 80 %>
                        <span class="text-success">ğŸŒŸ å„ªç§€</span>
                      <% elsif rate >= 60 %>
                        <span class="text-warning">ğŸ‘ è‰¯å¥½</span>
                      <% elsif rate >= 40 %>
                        <span class="text-info">ğŸ’ª æ™®é€š</span>
                      <% else %>
                        <span class="text-muted">ğŸ“ˆ è¦æ”¹å–„</span>
                      <% end %>
                    </td>
                    <td>
                      <% month_date = Date.new(@year, month_data[:month], 1) %>
                      <%= link_to monthly_statistics_path(year: @year, month: month_data[:month]), 
                                  class: "btn btn-outline-primary btn-sm" do %>
                        è©³ç´°
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å¹´é–“çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">ğŸ“Š <%= @year %>å¹´ã®æˆæœ</h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 mb-3">
              <h6 class="text-muted mb-1">å‚åŠ æ—¥æ•°</h6>
              <h4 class="text-primary"><%= @yearly_stats[:total_stamps] %>æ—¥</h4>
            </div>
            <div class="col-6 mb-3">
              <h6 class="text-muted mb-1">ä¸å‚åŠ æ—¥æ•°</h6>
              <h4 class="text-secondary"><%= @yearly_stats[:days_in_year] - @yearly_stats[:total_stamps] %>æ—¥</h4>
            </div>
            <div class="col-6 mb-3">
              <h6 class="text-muted mb-1">æœ€é«˜æœˆé–“è¨˜éŒ²</h6>
              <h4 class="text-warning">
                <%= @yearly_stats[:monthly_breakdown].map { |m| m[:stamp_count] }.max %>æ—¥
              </h4>
            </div>
            <div class="col-6 mb-3">
              <h6 class="text-muted mb-1">å¹³å‡æœˆé–“è¨˜éŒ²</h6>
              <h4 class="text-info">
                <%= (@yearly_stats[:total_stamps].to_f / 12).round(1) %>æ—¥
              </h4>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">ğŸ¯ <%= @year %>å¹´ã®ç›®æ¨™é”æˆåº¦</h5>
        </div>
        <div class="card-body">
          <% yearly_goal_days = 300 # ç›®æ¨™æ—¥æ•°ï¼ˆå¹´é–“300æ—¥å‚åŠ ï¼‰ %>
          <% achievement_rate = [@yearly_stats[:total_stamps].to_f / yearly_goal_days * 100, 100].min %>
          
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span>å¹´é–“ç›®æ¨™ (<%= yearly_goal_days %>æ—¥)</span>
              <span><%= achievement_rate.round(1) %>%</span>
            </div>
            <div class="progress" style="height: 20px;">
              <div class="progress-bar <%= 
                achievement_rate >= 80 ? 'bg-success' : 
                achievement_rate >= 60 ? 'bg-warning' : 'bg-info' 
              %>" 
                   role="progressbar" 
                   style="width: <%= achievement_rate %>%">
                <%= @yearly_stats[:total_stamps] %>æ—¥
              </div>
            </div>
          </div>

          <div class="text-center">
            <% if achievement_rate >= 80 %>
              <h6 class="text-success">ğŸ‰ ç›®æ¨™é”æˆãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</h6>
            <% elsif achievement_rate >= 60 %>
              <h6 class="text-warning">ğŸ‘ ã‚‚ã†å°‘ã—ã§ç›®æ¨™é”æˆã§ã™ï¼</h6>
            <% else %>
              <h6 class="text-info">ğŸ’ª æ¥å¹´ã¯ã‚‚ã£ã¨é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼</h6>
            <% end %>
            
            <p class="text-muted small mb-0">
              æ®‹ã‚Š<%= [yearly_goal_days - @yearly_stats[:total_stamps], 0].max %>æ—¥ã§ç›®æ¨™é”æˆ
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.jsçµ±åˆ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// æœˆåˆ¥å‚åŠ æ•°æ¨ç§»ã‚°ãƒ©ãƒ•
const monthlyProgressCtx = document.getElementById('monthlyProgressChart').getContext('2d');
const monthlyProgressChart = new Chart(monthlyProgressCtx, {
    type: 'line',
    data: {
        labels: [<%= @yearly_stats[:monthly_breakdown].map { |m| "'#{m[:month]}æœˆ'" }.join(', ').html_safe %>],
        datasets: [{
            label: 'å‚åŠ æ•°',
            data: [<%= @yearly_stats[:monthly_breakdown].map { |m| m[:stamp_count] }.join(', ') %>],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1,
            fill: true
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: '<%= @year %>å¹´ æœˆåˆ¥å‚åŠ æ•°ã®æ¨ç§»'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'å‚åŠ æ•°'
                }
            }
        }
    }
});

// æœˆåˆ¥å‚åŠ ç‡ã‚°ãƒ©ãƒ•
const monthlyRateCtx = document.getElementById('monthlyRateChart').getContext('2d');
const monthlyRateChart = new Chart(monthlyRateCtx, {
    type: 'bar',
    data: {
        labels: [<%= @yearly_stats[:monthly_breakdown].map { |m| "'#{m[:month]}æœˆ'" }.join(', ').html_safe %>],
        datasets: [{
            label: 'å‚åŠ ç‡ (%)',
            data: [<%= @yearly_stats[:monthly_breakdown].map { |m| m[:participation_rate] }.join(', ') %>],
            backgroundColor: [<%= @yearly_stats[:monthly_breakdown].map { |m| 
              rate = m[:participation_rate]
              if rate >= 80
                "'rgba(40, 167, 69, 0.8)'"
              elsif rate >= 60
                "'rgba(255, 193, 7, 0.8)'"
              elsif rate >= 40
                "'rgba(23, 162, 184, 0.8)'"
              else
                "'rgba(108, 117, 125, 0.8)'"
              end
            }.join(', ').html_safe %>],
            borderColor: [<%= @yearly_stats[:monthly_breakdown].map { |m| 
              rate = m[:participation_rate]
              if rate >= 80
                "'rgba(40, 167, 69, 1)'"
              elsif rate >= 60
                "'rgba(255, 193, 7, 1)'"
              elsif rate >= 40
                "'rgba(23, 162, 184, 1)'"
              else
                "'rgba(108, 117, 125, 1)'"
              end
            }.join(', ').html_safe %>],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: '<%= @year %>å¹´ æœˆåˆ¥å‚åŠ ç‡'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                title: {
                    display: true,
                    text: 'å‚åŠ ç‡ (%)'
                }
            }
        }
    }
});
</script>