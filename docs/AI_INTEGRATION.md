# AI連携システム - Claude & Gemini 自律連携

## 概要
Radio-Calisthenicsプロジェクトにおけるクロード Code と Gemini CLI の自律連携システムについて説明します。

## 【新しい役割分担】自律連携システム

### 逆転フロー開発原則
従来の「Claude実装→Gemini検証」から「Claude分析→Gemini実装→Claude検証」へ転換：

- **Claude Code**: 分析・計画立案 → 検証・統合・最適化
  - Issue分析、技術要件定義、実装計画立案
  - Gemini実装結果の品質検証・統合・改善指摘
  - プロジェクト全体のタスク管理・進捗管理
  - Phase Issue自動作成・GitHub連携統合

- **Gemini CLI**: 大規模実装・コード生成
  - Claudeの詳細計画に基づく実際のコード実装
  - ファイル作成・修正、テストコード生成
  - エラーハンドリング・セキュリティ考慮した実装

- **ユーザー**: 要件定義・最終判断
  - プロジェクトの目的・要件・最終ゴールを定義
  - AI連携結果の最終承認・方針決定

## 自律連携実装フロー

### Phase 1: Claude分析・計画立案
1. **Issue分析・タスク計画**（Claude担当）
   - GitHub Issue自動作成・ラベル・マイルストーン設定
   - gh-dashダッシュボードでの進捗可視化
2. **技術要件定義・リスク評価**
   - Phase実装テンプレートに基づく要件整理
3. **詳細実装指示の作成**（JSON形式）
   - Issue内容と連動した実装計画

### Phase 2: Gemini大規模実装
1. **Claudeの計画に基づく実装**（Gemini担当）
   - GitHub Issue参照による実装内容確認
2. **ファイル作成・修正・テストコード生成**
   - Issue進捗更新・コメント追加
3. **Rails規約準拠・セキュリティ考慮**
   - 実装状況のラベル管理

### Phase 3: Claude品質検証
1. **実装結果の品質検証**（Claude担当）
   - Issue状態更新・レビューコメント追加
2. **改善指摘・統合作業**
   - GitHub PR自動作成・品質チェック
3. **LGTM判定まで改善ループ継続**
   - Issue完了・マイルストーン進捗管理

## 連携コマンド例

### Claude → Gemini（実装指示）
```bash
gemini -p "Radio-Calisthenicsプロジェクトで以下の計画で実装してください:

タスク: [具体的なタスク説明]
実装手順:
1. [詳細ステップ1]
2. [詳細ステップ2]

技術要件:
- Rails 8 + PostgreSQL + Bootstrap対応
- RSpec テスト実装必須
- セキュリティ考慮

対象ファイル: [作成・修正ファイルリスト]
"
```

### Gemini → Claude（実装完了報告）
```bash
# Gemini実装後のClaude検証
claude_code_review "実装完了。レビューお願いします:

実装ファイル:
[実装したファイルと内容の詳細]

修正内容:
[具体的な修正内容]

テスト結果:
[テスト実行結果]
"
```

## 実践ガイド

### 基本ワークフロー
1. **Issue受信** → Claude分析・計画立案
2. **自動Issue振り分け** → Claudeが実現したい内容を分析し、自動でGeminiに実装指示を送信
3. **Gemini実装** → 大規模コード実装・ファイル作成・修正
4. **品質検証** → Claudeで統合・改善指摘
5. **改善ループ** → LGTM達成まで継続

### 🤖 自動Issue振り分け機能
Claudeに実現したいことを伝えると、以下の流れで自動的にGeminiに作業が振り分けられます：

### 自動実行トリガー条件
```
ユーザー指示: "Phase[N]を実装して" または "Geminiに[機能]を実装させて"
→ Claude自動判断: 大規模実装が必要と判断した場合
→ 自動Gemini連携開始
```

### 具体的な実行フロー
1. **要件分析**: Claudeがユーザーの要求を技術要件に変換
2. **実装計画立案**: 詳細な実装手順・対象ファイル・技術要件を整理  
3. **自動Gemini指示**: Bash toolでGemini CLI実行
   ```bash
   # Claude Codeが自動実行
   gemini -p "Radio-Calisthenicsプロジェクトで以下を実装してください:
   [生成された詳細な実装指示]"
   ```
4. **結果確認**: Gemini実行結果の受信・分析
5. **品質検証**: Claude Code内でコードレビュー実施
6. **改善ループ**: 問題があれば追加指示・修正依頼

### Gemini呼び出しのタイミング例
- **依頼受信時**: `gemini -p "Rails 8でスタンプカード管理機能を実装したい。最適なアプローチは？"`
- **エラー発生時**: `gemini -p "ActiveRecord::RecordInvalid エラーが発生。原因と解決法は？"`
- **設計判断時**: `gemini -p "ユーザー認証にDevise以外の選択肢はあるか？メリット・デメリットは？"`
- **実装前確認**: `gemini -p "このマイグレーションファイルに問題はないか？[ファイル内容]"`

### リトライ戦略
**パターン1: 情報を分割して質問**
```bash
# ❌ 曖昧な質問
gemini -p "Railsアプリが動かない"

# ✅ 具体的な質問
gemini -p "Rails 8でdocker-compose up時にBootstrap関連でエラー。解決法は？"
```

**パターン2: 実行コマンドを含める**
```bash
# Geminiがコマンド実行可能
gemini -p "bundle exec rspec spec/models/user_spec.rb を実行してエラー分析して"
```

**パターン3: ファイル内容を渡す**
```bash
gemini -p "以下のGemfileの依存関係に問題はないか？ [Gemfile内容をペースト]"
```

## 🛡️ エラーハンドリング・フォールバック戦略

### Gemini CLI接続エラー対処
```bash
# 1. 接続テスト
gemini -p "Hello, テスト接続です"

# 2. エラー時のフォールバック
if [ $? -eq 0 ]; then
    # 正常: 自動連携実行
    echo "Gemini CLI接続OK - 自動連携開始"
else
    # エラー: 手動実行案内
    echo "Gemini CLI接続エラー - 手動実行が必要です"
    echo "以下のコマンドを実行してください:"
    echo "gemini -p '[生成された実装指示]'"
fi
```

### 実装品質チェック基準
- **構文エラー**: Rails アプリが起動するか
- **テスト通過**: 基本的なRSpecテストが通るか  
- **セキュリティ**: Strong Parameters等が適切か
- **機能動作**: 指定された機能が動作するか

### 改善ループ終了条件
```
✅ LGTM判定基準:
1. 構文エラーなし (rails console起動OK)
2. 基本テスト通過 (bundle exec rspec)
3. セキュリティチェックOK
4. 機能要件充足
5. コード品質基準充足
```

### 重要な判断基準
- **Claude Code内蔵のWebSearchツールは使用禁止** → Geminiで代替
- **Geminiの意見は1つの視点** → 聞き方を変えて多角的に検証
- **思い込み・過信の回避** → 前提条件も含めてGeminiで確認
- **自動連携失敗時**: 手動実行へ即座にフォールバック
- **品質基準未達時**: 改善指示を明確化してリトライ

### 主要な活用場面
1. **実現不可能な依頼**: Claude Codeでは実現できない要求への対処 (例: `今日の天気は？`)
2. **前提確認**: ユーザー、Claude自身に思い込みや勘違い、過信がないかどうか逐一確認 (例: `この前提は正しいか？`）
3. **技術調査**: 最新情報・エラー解決・ドキュメント検索・調査方法の確認（例: `Rails 7.2の新機能を調べて`）
4. **設計検証**: アーキテクチャ・実装方針の妥当性確認（例: `この設計パターンは適切か？`）
5. **コードレビュー**: 品質・保守性・パフォーマンスの評価（例: `このコードの改善点は？`）
6. **計画立案**: タスクの実行計画レビュー・改善提案（例: `この実装計画の問題点は？`）
7. **技術選定**: ライブラリ・手法の比較検討 （例: `このライブラリは他と比べてどうか？`）

## AI連携の制限事項・注意点

### セキュリティ・プライバシー考慮事項

#### 🚨 機密情報の取り扱い
```bash
# ❌ 絶対に送信してはいけない情報
- API キー、パスワード、秘密鍵
- 個人情報（メールアドレス、電話番号等）
- 本番環境の設定情報
- データベースの実際のデータ

# ✅ 安全な情報共有例
gemini -p "Rails認証の実装方法（コードサンプルは仮の内容で）"
gemini -p "以下のgemfileの依存関係チェック（個人情報削除済み）"
```

#### 🔐 コード共有時の注意点
1. **機密情報マスク**: APIキー等は `[API_KEY]` で置換
2. **サンプルデータ使用**: 実際のユーザーデータは使わない
3. **環境分離**: 本番設定は絶対に共有しない
4. **ログの注意**: エラーログも個人情報が含まれる可能性

### AI技術の制限事項

#### Gemini CLIの制限
1. **リアルタイム情報**: 最新のGem情報等は古い場合がある
2. **プロジェクト固有情報**: あなたの環境固有の問題は解決困難
3. **複雑な設計判断**: ビジネス要件を理解した判断は不可能
4. **コード実行環境**: ローカル環境でのテストは不可

#### Claude Codeの制限
1. **外部API呼び出し**: WebSearchは禁止（Geminiで代替）
2. **ファイルサイズ**: 大きなファイルの一括処理は困難
3. **デバッグ実行**: ブレークポイント等の対話的デバッグ不可
4. **GUI操作**: ブラウザ操作等は不可

### パフォーマンス最適化のコツ

#### 効率的なGemini活用
```bash
# ✅ 一度に複数の関連質問
gemini -p "Rails StampCardモデルについて以下を教えて:
1. 基本的なValidation設定
2. User との関連付け方法
3. 初学者が陥りやすいミス"

# ❌ 連続した単発質問（API使用量が多い）
gemini -p "StampCardモデルのvalidationは？"
gemini -p "StampCardとUserの関連は？"
gemini -p "よくあるミスは？"
```

#### Claude Code最適化
1. **ファイル分割**: 大きなファイルは小さく分けて処理
2. **段階的実装**: 一度に全て実装せず、段階的に進める
3. **定期的な中間確認**: 各段階でGeminiによる検証実施
4. **エラー早期発見**: 小さい単位でテスト実行

### 緊急時対応フロー

#### システム障害時
1. **Gemini確認**: `gemini -p "Rails production 500エラーの一般的原因と調査手順"`
2. **ログ分析**: エラーログを（機密情報除去して）Geminiで分析
3. **Claude実装**: Geminiのアドバイスを基にClaude Codeで修正
4. **検証**: 修正後、再度Geminiで検証

#### 開発ブロック時
1. **問題分析**: Geminiで技術的選択肢を確認
2. **実装方針決定**: ユーザーが最終判断
3. **Claude実装**: 決定した方針でClaude Codeが実装
4. **品質確認**: Geminiでコードレビュー

### ベストプラクティスまとめ

#### 三位一体開発の原則再確認
- **ユーザー**: 要件定義・最終判断・ビジネス観点
- **Claude**: 実装・リファクタリング・タスク管理
- **Gemini**: 技術検証・コードレビュー・最新情報

#### 成功する開発フロー
1. **計画**: Geminiで技術調査 → ユーザー判断
2. **実装**: Claudeで段階的実装
3. **検証**: Geminiでレビュー → Claude修正
4. **完成**: ユーザー確認 → 次の機能へ

このフローを守ることで、セキュアかつ効率的な開発が実現できます。

## 🚀 自律連携システム実行ガイド

### 事前確認
自動連携を実行する前に、システム状態を確認してください：
```bash
# 連携システムテストを実行
bash scripts/test_claude_gemini_integration.sh
```

### 自動連携の実行方法

#### パターン1: 自動実行（推奨）
Claude Codeに以下のように指示：
```
"Phase2を実装して"
"Phase3の統計機能をGeminiに実装させて"
"○○機能をGeminiで実装して"
```

#### パターン2: 手動実行（フォールバック）
自動連携が失敗した場合：
```bash
# Phase2の例
gemini -p "$(cat GEMINI_PHASE2_ISSUE.md)"

# または具体的な指示
gemini -p "Radio-Calisthenicsプロジェクトで[具体的な実装内容]"
```

### 実行後の品質管理
1. **Claude Codeでコードレビュー**
2. **テスト実行**: `docker-compose exec web bundle exec rspec`
3. **動作確認**: Rails アプリケーションの起動確認
4. **改善ループ**: 問題があれば追加指示

### トラブルシューティング
- **Gemini CLI接続エラー**: API キー設定を確認
- **Docker環境エラー**: `docker-compose up` を実行
- **Rails エラー**: マイグレーション・依存関係を確認
- **テスト失敗**: 構文エラー・設定ミスを修正

### 成功確認
✅ すべてのテストが通過
✅ Rails アプリケーションが正常起動
✅ 実装された機能が動作